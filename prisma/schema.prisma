// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum Role {
  ADMIN
  TECNICO
  RECEPCIONISTA
}

enum EstadoPresupuesto {
  PENDIENTE
  ACEPTADO
  RECHAZADO
  VENCIDO
}

enum EstadoOrden {
  RECIBIDO
  EN_DIAGNOSTICO
  EN_REPARACION
  ESPERANDO_REFACCION
  TERMINADO
  ENTREGADO
  CANCELADO
}

enum Prioridad {
  NORMAL
  URGENTE
}

enum TipoRefaccion {
  ORIGINAL
  GENERICA
  USADA
}

enum TipoMovimiento {
  ENTRADA
  SALIDA
  AJUSTE
}

enum MetodoPago {
  EFECTIVO
  TARJETA
  TRANSFERENCIA
}

// ============================================================================
// MODELS
// ============================================================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String // bcrypt hashed
  name      String
  role      Role     @default(TECNICO)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ordenes               Orden[]
  pagos                 Pago[]
  historialEstados      HistorialEstadoOrden[]
  movimientosInventario MovimientoInventario[]
  ventas                Venta[]
}

model Cliente {
  id              String   @id @default(uuid())
  nombre          String
  apellido        String
  telefono        String   @unique
  telefonoAlterno String?
  email           String?
  direccion       String?
  notas           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  ordenes      Orden[]
  equipos      Equipo[]
  ventas       Venta[]
  presupuestos Presupuesto[]

  @@index([telefono])
  @@index([nombre, apellido])
}

model Equipo {
  id        String   @id @default(uuid())
  clienteId String
  marca     String
  modelo    String
  imei      String?  @unique
  color     String?
  capacidad String?
  notas     String?
  createdAt DateTime @default(now())

  cliente      Cliente       @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  ordenes      Orden[]
  presupuestos Presupuesto[]

  @@index([clienteId])
  @@index([imei])
}

model Presupuesto {
  id                  String            @id @default(uuid())
  folio               String            @unique
  clienteId           String
  equipoId            String?
  descripcionProblema String
  montoEstimado       Decimal           @db.Decimal(10, 2)
  estado              EstadoPresupuesto @default(PENDIENTE)
  vigenciaDias        Int               @default(15)
  fechaVencimiento    DateTime
  medioEnvio          String?
  fechaEnvio          DateTime?
  observaciones       String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  cliente Cliente @relation(fields: [clienteId], references: [id])
  equipo  Equipo? @relation(fields: [equipoId], references: [id])
  orden   Orden?

  @@index([folio])
  @@index([clienteId])
  @@index([estado])
}

model Orden {
  id                  String      @id @default(uuid())
  folio               String      @unique
  clienteId           String
  equipoId            String
  presupuestoId       String?     @unique
  problemaReportado   String
  diagnosticoTecnico  String?
  tipoReparacion      String
  reparacionRealizada String?
  estado              EstadoOrden @default(RECIBIDO)
  prioridad           Prioridad   @default(NORMAL)

  // Control de recepción
  conSIM            Boolean @default(false)
  conFunda          Boolean @default(false)
  conMemoriaSD      Boolean @default(false)
  estadoEncendido   Boolean @default(false)
  nivelBateria      Int?
  tieneBloqueo      Boolean @default(false)
  tipoBloqueo       String?
  codigoProporciona Boolean @default(false)
  estadoFisico      String?

  // Costos
  costoTotal Decimal @db.Decimal(10, 2)
  anticipo   Decimal @default(0) @db.Decimal(10, 2)
  adeudo     Decimal @db.Decimal(10, 2) // Calculado

  // Fechas
  fechaIngreso         DateTime  @default(now())
  fechaEstimadaEntrega DateTime
  fechaRealEntrega     DateTime?

  // Garantía
  tieneGarantia            Boolean   @default(true)
  diasGarantia             Int       @default(15)
  fechaVencimientoGarantia DateTime?

  // Relaciones
  tecnicoId             String?
  observacionesTecnicas String?
  notasInternas         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cliente           Cliente                @relation(fields: [clienteId], references: [id])
  equipo            Equipo                 @relation(fields: [equipoId], references: [id])
  presupuesto       Presupuesto?           @relation(fields: [presupuestoId], references: [id])
  tecnico           User?                  @relation(fields: [tecnicoId], references: [id])
  historialEstados  HistorialEstadoOrden[]
  refaccionesUsadas OrdenRefaccion[]
  pagos             Pago[]

  @@index([folio])
  @@index([clienteId])
  @@index([equipoId])
  @@index([estado])
  @@index([fechaIngreso])
}

model HistorialEstadoOrden {
  id             String       @id @default(uuid())
  ordenId        String
  estadoAnterior EstadoOrden?
  estadoNuevo    EstadoOrden
  usuarioId      String?
  notas          String?
  createdAt      DateTime     @default(now())

  orden   Orden @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  usuario User? @relation(fields: [usuarioId], references: [id])

  @@index([ordenId])
}

model Refaccion {
  id          String        @id @default(uuid())
  codigo      String        @unique
  nombre      String
  tipo        TipoRefaccion
  categoria   String
  costoCompra Decimal       @db.Decimal(10, 2)
  precioVenta Decimal       @db.Decimal(10, 2)
  stockActual Int           @default(0)
  stockMinimo Int           @default(5)
  ubicacion   String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  ordenesUsadas OrdenRefaccion[]
  movimientos   MovimientoInventario[]

  @@index([codigo])
  @@index([stockActual])
}

model OrdenRefaccion {
  id             String   @id @default(uuid())
  ordenId        String
  refaccionId    String
  cantidad       Int
  precioUnitario Decimal  @db.Decimal(10, 2)
  createdAt      DateTime @default(now())

  orden     Orden     @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  refaccion Refaccion @relation(fields: [refaccionId], references: [id])

  @@index([ordenId])
  @@index([refaccionId])
}

model MovimientoInventario {
  id          String         @id @default(uuid())
  refaccionId String
  tipo        TipoMovimiento
  cantidad    Int
  motivo      String?
  usuarioId   String?
  createdAt   DateTime       @default(now())

  refaccion Refaccion @relation(fields: [refaccionId], references: [id])
  usuario   User?     @relation(fields: [usuarioId], references: [id])

  @@index([refaccionId])
}

model Accesorio {
  id           String   @id @default(uuid())
  codigo       String   @unique
  nombre       String
  categoria    String
  marca        String?
  precioCompra Decimal  @db.Decimal(10, 2)
  precioVenta  Decimal  @db.Decimal(10, 2)
  stockActual  Int      @default(0)
  stockMinimo  Int      @default(5)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  ventasItems VentaItem[]

  @@index([codigo])
}

model Venta {
  id         String     @id @default(uuid())
  folio      String     @unique
  clienteId  String?
  total      Decimal    @db.Decimal(10, 2)
  descuento  Decimal    @default(0) @db.Decimal(10, 2)
  metodoPago MetodoPago
  usuarioId  String?
  createdAt  DateTime   @default(now())

  cliente Cliente?    @relation(fields: [clienteId], references: [id])
  usuario User?       @relation(fields: [usuarioId], references: [id])
  items   VentaItem[]
  pagos   Pago[]

  @@index([folio])
  @@index([clienteId])
}

model VentaItem {
  id             String  @id @default(uuid())
  ventaId        String
  accesorioId    String
  cantidad       Int
  precioUnitario Decimal @db.Decimal(10, 2)

  venta     Venta     @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  accesorio Accesorio @relation(fields: [accesorioId], references: [id])

  @@index([ventaId])
}

model Pago {
  id         String     @id @default(uuid())
  ordenId    String?
  ventaId    String?
  monto      Decimal    @db.Decimal(10, 2)
  metodoPago MetodoPago
  concepto   String
  usuarioId  String?
  createdAt  DateTime   @default(now())

  orden   Orden? @relation(fields: [ordenId], references: [id])
  venta   Venta? @relation(fields: [ventaId], references: [id])
  usuario User?  @relation(fields: [usuarioId], references: [id])

  @@index([ordenId])
  @@index([createdAt])
}

model Configuracion {
  id    String @id @default(uuid())
  clave String @unique
  valor String

  @@index([clave])
}
