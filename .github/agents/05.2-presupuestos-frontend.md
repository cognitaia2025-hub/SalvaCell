# Agent: Presupuestos Frontend

## Instrucción de Idioma
**IMPORTANTE:** Todos los procesos, informes, commits, y documentación generados por este agente deben realizarse en español hispanohablante para facilitar la comprensión del equipo.

## Rol
Ingeniero Frontend especializado en React, TypeScript, formularios con React Hook Form y UI/UX.

## Objetivo
Implementar la interfaz de usuario completa para el módulo de presupuestos, incluyendo formulario de creación, lista con filtros, botón de conversión a orden, y funcionalidad de envío por WhatsApp.

## Contexto del Proyecto
SalvaCell requiere una interfaz para gestionar presupuestos que permita:
- Crear presupuestos de forma rápida y sencilla
- Ver lista de presupuestos con filtros por estado
- Convertir presupuestos aceptados a órdenes con un clic
- Enviar presupuestos por WhatsApp directamente
- Gestionar estados (PENDIENTE/ACEPTADO/RECHAZADO/VENCIDO)

## Documentación de Referencia
Revisar `/home/runner/work/SalvaCell/SalvaCell/docs/`:
- `FSD.md` - UI Components y flujos de usuario
- `PRD.md` - Historias US-PRES-001 y US-PRES-002
- `SRS.md` - RF-PRE-001 a RF-PRE-004

## Pre-requisitos
✅ `05.1-presupuestos-backend` debe haber completado la API
✅ Proyecto React con shadcn/ui configurado
✅ React Router y Zustand configurados
✅ `04.2-clientes-frontend` completado (para selección de clientes)

## Tareas Específicas

### 1. Crear Tipos TypeScript

**Archivo:** `frontend/src/types/presupuesto.ts`

```typescript
export type EstadoPresupuesto = 'PENDIENTE' | 'ACEPTADO' | 'RECHAZADO' | 'VENCIDO';

export interface Presupuesto {
  id: string;
  folio: string;
  clienteId: string;
  equipoId?: string | null;
  descripcionProblema: string;
  montoEstimado: number;
  estado: EstadoPresupuesto;
  vigenciaDias: number;
  fechaVencimiento: string;
  medioEnvio?: string | null;
  fechaEnvio?: string | null;
  observaciones?: string | null;
  createdAt: string;
  updatedAt: string;
  cliente?: {
    id: string;
    nombre: string;
    apellido: string;
    telefono: string;
  };
  equipo?: {
    id: string;
    marca: string;
    modelo: string;
  };
  orden?: {
    id: string;
    folio: string;
    estado: string;
  };
}
```

### 2. Crear Servicio API

**Archivo:** `frontend/src/services/presupuestoService.ts`

```typescript
import axios from 'axios';
import { Presupuesto, EstadoPresupuesto } from '@/types/presupuesto';

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:5000';

export const presupuestoService = {
  async getPresupuestos(params?: {
    estado?: EstadoPresupuesto;
    clienteId?: string;
    page?: number;
    limit?: number;
  }) {
    const { data } = await axios.get(`${API_URL}/api/presupuestos`, { params });
    return data.data;
  },

  async getPresupuestoById(id: string): Promise<Presupuesto> {
    const { data } = await axios.get(`${API_URL}/api/presupuestos/${id}`);
    return data.data;
  },

  async createPresupuesto(presupuesto: Partial<Presupuesto>): Promise<Presupuesto> {
    const { data } = await axios.post(`${API_URL}/api/presupuestos`, presupuesto);
    return data.data;
  },

  async updatePresupuesto(id: string, presupuesto: Partial<Presupuesto>): Promise<Presupuesto> {
    const { data } = await axios.put(`${API_URL}/api/presupuestos/${id}`, presupuesto);
    return data.data;
  },

  async cambiarEstado(id: string, estado: 'ACEPTADO' | 'RECHAZADO', observaciones?: string) {
    const { data } = await axios.patch(`${API_URL}/api/presupuestos/${id}/estado`, {
      estado,
      observaciones,
    });
    return data.data;
  },

  async convertirAOrden(id: string) {
    const { data } = await axios.post(`${API_URL}/api/presupuestos/${id}/convertir-orden`);
    return data.data;
  },

  async generarEnlaceWhatsApp(id: string) {
    const { data } = await axios.get(`${API_URL}/api/presupuestos/${id}/whatsapp`);
    return data.data;
  },

  async deletePresupuesto(id: string) {
    const { data } = await axios.delete(`${API_URL}/api/presupuestos/${id}`);
    return data.data;
  },
};
```

### 3. Crear Store Zustand

**Archivo:** `frontend/src/stores/presupuestoStore.ts`

```typescript
import { create } from 'zustand';
import { Presupuesto } from '@/types/presupuesto';
import { presupuestoService } from '@/services/presupuestoService';

interface PresupuestoState {
  presupuestos: Presupuesto[];
  presupuestoSeleccionado: Presupuesto | null;
  isLoading: boolean;
  error: string | null;
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
  
  fetchPresupuestos: (params?: any) => Promise<void>;
  fetchPresupuestoById: (id: string) => Promise<void>;
  createPresupuesto: (presupuesto: Partial<Presupuesto>) => Promise<Presupuesto>;
  convertirAOrden: (id: string) => Promise<any>;
  generarEnlaceWhatsApp: (id: string) => Promise<any>;
}

export const usePresupuestoStore = create<PresupuestoState>((set, get) => ({
  presupuestos: [],
  presupuestoSeleccionado: null,
  isLoading: false,
  error: null,
  pagination: { page: 1, limit: 20, total: 0, totalPages: 0 },
  
  fetchPresupuestos: async (params) => {
    set({ isLoading: true, error: null });
    try {
      const result = await presupuestoService.getPresupuestos(params);
      set({ presupuestos: result.presupuestos, pagination: result.pagination, isLoading: false });
    } catch (error: any) {
      set({ error: error.message, isLoading: false });
    }
  },
  
  fetchPresupuestoById: async (id) => {
    set({ isLoading: true, error: null });
    try {
      const presupuesto = await presupuestoService.getPresupuestoById(id);
      set({ presupuestoSeleccionado: presupuesto, isLoading: false });
    } catch (error: any) {
      set({ error: error.message, isLoading: false });
    }
  },
  
  createPresupuesto: async (presupuesto) => {
    set({ isLoading: true, error: null });
    try {
      const nuevo = await presupuestoService.createPresupuesto(presupuesto);
      set({ isLoading: false });
      return nuevo;
    } catch (error: any) {
      set({ error: error.message, isLoading: false });
      throw error;
    }
  },
  
  convertirAOrden: async (id) => {
    set({ isLoading: true, error: null });
    try {
      const orden = await presupuestoService.convertirAOrden(id);
      set({ isLoading: false });
      get().fetchPresupuestos();
      return orden;
    } catch (error: any) {
      set({ error: error.message, isLoading: false });
      throw error;
    }
  },
  
  generarEnlaceWhatsApp: async (id) => {
    try {
      return await presupuestoService.generarEnlaceWhatsApp(id);
    } catch (error: any) {
      throw error;
    }
  },
}));
```

### 4. Crear Componente Badge de Estado

**Archivo:** `frontend/src/components/presupuestos/EstadoBadge.tsx`

```typescript
import { Badge } from '@/components/ui/badge';
import { EstadoPresupuesto } from '@/types/presupuesto';

interface EstadoBadgeProps {
  estado: EstadoPresupuesto;
}

export function EstadoBadge({ estado }: EstadoBadgeProps) {
  const config = {
    PENDIENTE: { label: 'Pendiente', className: 'bg-yellow-100 text-yellow-800' },
    ACEPTADO: { label: 'Aceptado', className: 'bg-green-100 text-green-800' },
    RECHAZADO: { label: 'Rechazado', className: 'bg-red-100 text-red-800' },
    VENCIDO: { label: 'Vencido', className: 'bg-gray-100 text-gray-800' },
  };

  const { label, className } = config[estado];

  return <Badge className={className}>{label}</Badge>;
}
```

### 5. Crear Formulario de Presupuesto

**Archivo:** `frontend/src/components/presupuestos/PresupuestoForm.tsx`

```typescript
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

const presupuestoSchema = z.object({
  clienteId: z.string().min(1, 'Cliente requerido'),
  equipoId: z.string().optional(),
  descripcionProblema: z.string().min(10, 'Mínimo 10 caracteres'),
  montoEstimado: z.number().positive('Debe ser positivo'),
  vigenciaDias: z.number().int().min(1).max(90).default(15),
  observaciones: z.string().optional(),
});

type PresupuestoFormData = z.infer<typeof presupuestoSchema>;

interface PresupuestoFormProps {
  onSubmit: (data: PresupuestoFormData) => void;
  isLoading?: boolean;
}

export function PresupuestoForm({ onSubmit, isLoading }: PresupuestoFormProps) {
  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<PresupuestoFormData>({
    resolver: zodResolver(presupuestoSchema),
    defaultValues: {
      vigenciaDias: 15,
    },
  });

  return (
    <Card>
      <CardHeader>
        <CardTitle>Nuevo Presupuesto</CardTitle>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          {/* Cliente Selector - implementar con búsqueda */}
          <div>
            <Label>Cliente *</Label>
            <Input {...register('clienteId')} placeholder="Seleccionar cliente" />
            {errors.clienteId && <p className="text-sm text-red-600">{errors.clienteId.message}</p>}
          </div>

          <div>
            <Label>Descripción del Problema *</Label>
            <Textarea {...register('descripcionProblema')} rows={4} />
            {errors.descripcionProblema && <p className="text-sm text-red-600">{errors.descripcionProblema.message}</p>}
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label>Monto Estimado *</Label>
              <Input type="number" step="0.01" {...register('montoEstimado', { valueAsNumber: true })} />
              {errors.montoEstimado && <p className="text-sm text-red-600">{errors.montoEstimado.message}</p>}
            </div>

            <div>
              <Label>Vigencia (días)</Label>
              <Input type="number" {...register('vigenciaDias', { valueAsNumber: true })} />
              {errors.vigenciaDias && <p className="text-sm text-red-600">{errors.vigenciaDias.message}</p>}
            </div>
          </div>

          <div>
            <Label>Observaciones</Label>
            <Textarea {...register('observaciones')} rows={3} />
          </div>

          <Button type="submit" className="w-full" disabled={isLoading}>
            {isLoading ? 'Creando...' : 'Crear Presupuesto'}
          </Button>
        </form>
      </CardContent>
    </Card>
  );
}
```

### 6. Crear Lista de Presupuestos

**Archivo:** `frontend/src/components/presupuestos/PresupuestoList.tsx`

```typescript
import { useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { FileText, ArrowRight, Send } from 'lucide-react';
import { usePresupuestoStore } from '@/stores/presupuestoStore';
import { EstadoBadge } from './EstadoBadge';
import { formatCurrency } from '@/lib/utils';

export function PresupuestoList() {
  const navigate = useNavigate();
  const { presupuestos, isLoading, fetchPresupuestos } = usePresupuestoStore();

  useEffect(() => {
    fetchPresupuestos();
  }, []);

  if (isLoading) {
    return <div>Cargando...</div>;
  }

  return (
    <div className="space-y-4">
      {presupuestos.map((presupuesto) => (
        <Card key={presupuesto.id} className="hover:shadow-md transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-start justify-between">
              <div className="flex-1">
                <div className="flex items-center gap-3 mb-2">
                  <FileText size={20} className="text-gray-400" />
                  <h3 className="text-lg font-semibold">{presupuesto.folio}</h3>
                  <EstadoBadge estado={presupuesto.estado} />
                </div>

                {presupuesto.cliente && (
                  <p className="text-sm text-gray-600 mb-2">
                    Cliente: {presupuesto.cliente.nombre} {presupuesto.cliente.apellido}
                  </p>
                )}

                <p className="text-sm text-gray-700 mb-3">{presupuesto.descripcionProblema}</p>

                <div className="flex gap-6 text-sm">
                  <div>
                    <span className="text-gray-500">Monto: </span>
                    <span className="font-semibold">{formatCurrency(presupuesto.montoEstimado)}</span>
                  </div>
                  <div>
                    <span className="text-gray-500">Vence: </span>
                    <span className="font-medium">
                      {format(new Date(presupuesto.fechaVencimiento), 'dd MMM yyyy', { locale: es })}
                    </span>
                  </div>
                </div>
              </div>

              <div className="flex gap-2 ml-4">
                <Button variant="outline" size="sm" onClick={() => navigate(`/presupuestos/${presupuesto.id}`)}>
                  Ver
                </Button>
                {presupuesto.estado === 'ACEPTADO' && !presupuesto.orden && (
                  <Button size="sm" variant="default">
                    <ArrowRight size={16} className="mr-2" />
                    Convertir a Orden
                  </Button>
                )}
              </div>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}
```

### 7. Crear Página de Detalle con Conversión y WhatsApp

**Archivo:** `frontend/src/pages/PresupuestoDetalle.tsx`

```typescript
import { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { ArrowLeft, ArrowRight, Send, CheckCircle } from 'lucide-react';
import { usePresupuestoStore } from '@/stores/presupuestoStore';
import { EstadoBadge } from '@/components/presupuestos/EstadoBadge';
import { formatCurrency } from '@/lib/utils';
import { toast } from 'sonner';

export function PresupuestoDetalle() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const { presupuestoSeleccionado, isLoading, fetchPresupuestoById, convertirAOrden, generarEnlaceWhatsApp } = usePresupuestoStore();
  const [converting, setConverting] = useState(false);

  useEffect(() => {
    if (id) {
      fetchPresupuestoById(id);
    }
  }, [id]);

  const handleConvertir = async () => {
    if (!presupuestoSeleccionado) return;
    
    setConverting(true);
    try {
      const orden = await convertirAOrden(presupuestoSeleccionado.id);
      toast.success(`Orden ${orden.folio} creada exitosamente`);
      navigate(`/ordenes/${orden.id}`);
    } catch (error: any) {
      toast.error(error.message);
    } finally {
      setConverting(false);
    }
  };

  const handleEnviarWhatsApp = async () => {
    if (!presupuestoSeleccionado) return;

    try {
      const { enlace } = await generarEnlaceWhatsApp(presupuestoSeleccionado.id);
      window.open(enlace, '_blank');
      toast.success('Abriendo WhatsApp...');
    } catch (error: any) {
      toast.error(error.message);
    }
  };

  if (isLoading || !presupuestoSeleccionado) {
    return <div>Cargando...</div>;
  }

  const presupuesto = presupuestoSeleccionado;

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Button variant="ghost" size="sm" onClick={() => navigate('/presupuestos')}>
            <ArrowLeft size={20} />
          </Button>
          <h1 className="text-3xl font-bold">Presupuesto {presupuesto.folio}</h1>
        </div>
        <EstadoBadge estado={presupuesto.estado} />
      </div>

      {presupuesto.estado === 'ACEPTADO' && !presupuesto.orden && (
        <Alert>
          <CheckCircle size={16} />
          <AlertDescription>Este presupuesto fue aceptado y puede convertirse en orden.</AlertDescription>
        </Alert>
      )}

      <Card>
        <CardHeader>
          <CardTitle>Información del Presupuesto</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <p className="text-sm text-gray-500">Cliente</p>
              <p className="font-medium">
                {presupuesto.cliente?.nombre} {presupuesto.cliente?.apellido}
              </p>
            </div>
            <div>
              <p className="text-sm text-gray-500">Teléfono</p>
              <p className="font-medium">{presupuesto.cliente?.telefono}</p>
            </div>
            <div>
              <p className="text-sm text-gray-500">Monto Estimado</p>
              <p className="font-semibold text-lg">{formatCurrency(presupuesto.montoEstimado)}</p>
            </div>
            <div>
              <p className="text-sm text-gray-500">Vigencia</p>
              <p className="font-medium">{presupuesto.vigenciaDias} días</p>
            </div>
          </div>

          <div>
            <p className="text-sm text-gray-500 mb-2">Descripción del Problema</p>
            <p className="text-gray-700">{presupuesto.descripcionProblema}</p>
          </div>

          {presupuesto.observaciones && (
            <div>
              <p className="text-sm text-gray-500 mb-2">Observaciones</p>
              <p className="text-gray-700">{presupuesto.observaciones}</p>
            </div>
          )}
        </CardContent>
      </Card>

      <div className="flex gap-4">
        <Button onClick={handleEnviarWhatsApp} variant="outline">
          <Send size={16} className="mr-2" />
          Enviar por WhatsApp
        </Button>

        {presupuesto.estado === 'ACEPTADO' && !presupuesto.orden && (
          <Button onClick={handleConvertir} disabled={converting}>
            <ArrowRight size={16} className="mr-2" />
            {converting ? 'Convirtiendo...' : 'Convertir a Orden'}
          </Button>
        )}

        {presupuesto.orden && (
          <Button onClick={() => navigate(`/ordenes/${presupuesto.orden!.id}`)}>
            Ver Orden {presupuesto.orden.folio}
          </Button>
        )}
      </div>
    </div>
  );
}
```

## Criterios de Éxito

✅ **Formulario de Presupuesto:**
  - Campos validados con Zod ✅
  - Selector de cliente ✅
  - Cálculo automático de vigencia ✅

✅ **Lista de Presupuestos:**
  - Filtros por estado ✅
  - Badges visuales de estado ✅
  - Información resumida clara ✅

✅ **Conversión a Orden:**
  - Botón solo visible para ACEPTADOS ✅
  - Redirección a orden creada ✅
  - Confirmación con toast ✅

✅ **Envío por WhatsApp:**
  - Genera enlace automáticamente ✅
  - Abre en nueva pestaña ✅
  - Registra fecha de envío ✅

✅ **Estados Visuales:**
  - PENDIENTE: Amarillo ✅
  - ACEPTADO: Verde ✅
  - RECHAZADO: Rojo ✅
  - VENCIDO: Gris ✅

## Comandos de Verificación

```bash
npm install
npm run dev
```

## Entregables

1. ✅ `frontend/src/types/presupuesto.ts`
2. ✅ `frontend/src/services/presupuestoService.ts`
3. ✅ `frontend/src/stores/presupuestoStore.ts`
4. ✅ `frontend/src/components/presupuestos/EstadoBadge.tsx`
5. ✅ `frontend/src/components/presupuestos/PresupuestoForm.tsx`
6. ✅ `frontend/src/components/presupuestos/PresupuestoList.tsx`
7. ✅ `frontend/src/pages/PresupuestoDetalle.tsx`

## Próximos Pasos
- Integrar con módulo de órdenes
- Agregar filtros avanzados
- Implementar impresión de presupuestos

## Referencias
- React Hook Form: https://react-hook-form.com/
- Zustand: https://github.com/pmndrs/zustand
- shadcn/ui: https://ui.shadcn.com/
