# Agent: Database - Clientes y Equipos

> **Nota Importante:** Todos los procesos, informes y comunicaciones de este agente deben realizarse en espa√±ol hispanohablante para facilitar la comprensi√≥n y colaboraci√≥n del equipo.

## Rol
Especialista en Base de Datos enfocado en la implementaci√≥n de las tablas de clientes y equipos, incluyendo optimizaciones de b√∫squeda y relaciones.

## Objetivo
Implementar las tablas `clientes` y `equipos` en el schema de Prisma, crear √≠ndices optimizados para b√∫squedas, implementar seeds de datos de prueba con perfiles variados de clientes, y asegurar la correcta relaci√≥n 1:N entre clientes y equipos.

## Contexto del Proyecto
SalvaCell es un sistema de gesti√≥n integral para talleres de reparaci√≥n de dispositivos m√≥viles. Este agente se enfoca espec√≠ficamente en:
- Gesti√≥n completa de clientes con historial
- Registro de m√∫ltiples equipos por cliente
- B√∫squedas r√°pidas y eficientes por nombre, tel√©fono y email
- Detecci√≥n de clientes duplicados
- Clasificaci√≥n autom√°tica de clientes (VIP, Frecuente, Nuevo)

## Documentaci√≥n de Referencia
Revisar los siguientes documentos en la carpeta `/home/runner/work/SalvaCell/SalvaCell/docs/`:
- `FSD.md` - Secci√≥n 3.1 (modelos Cliente y Equipo)
- `SRS.md` - Secci√≥n 3.2 (RF-CLI-001 al RF-CLI-005)
- `PRD.md` - Secci√≥n 4 (Relaciones de datos)
- `BRD.md` - Requisitos de negocio relacionados con clientes

## Prerequisitos
‚úÖ El agente `01-database-architect.md` debe haber creado el schema base de Prisma
‚úÖ Debe existir la carpeta `prisma/` con `schema.prisma`
‚úÖ PostgreSQL debe estar configurado y accesible

## Tareas Espec√≠ficas

### 1. Verificar e Implementar Modelo Cliente
**Archivo:** `prisma/schema.prisma`

Asegurar que el modelo Cliente contenga todos los campos necesarios:

```prisma
model Cliente {
  id              String   @id @default(uuid())
  nombre          String
  apellido        String
  telefono        String   @unique
  telefonoAlterno String?
  email           String?  @unique
  direccion       String?
  notas           String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relaciones
  ordenes         Orden[]
  equipos         Equipo[]
  ventas          Venta[]
  presupuestos    Presupuesto[]
  
  // √çndices para optimizar b√∫squedas
  @@index([telefono])
  @@index([nombre, apellido])
  @@index([email])
  @@index([createdAt])
  @@map("clientes")
}
```

**Validaciones importantes:**
- `telefono` debe ser √∫nico y requerido (es el identificador principal del cliente)
- `email` debe ser √∫nico si se proporciona (para evitar duplicados)
- `nombre` y `apellido` son requeridos
- `notas` debe permitir texto largo con `@db.Text`

### 2. Verificar e Implementar Modelo Equipo
**Archivo:** `prisma/schema.prisma`

```prisma
model Equipo {
  id          String   @id @default(uuid())
  clienteId   String
  marca       String
  modelo      String
  imei        String?  @unique
  color       String?
  patron      String?  @db.Text
  observaciones String? @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relaciones
  cliente     Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  ordenes     Orden[]
  
  // √çndices para b√∫squedas
  @@index([clienteId])
  @@index([imei])
  @@index([marca, modelo])
  @@map("equipos")
}
```

**Validaciones importantes:**
- `clienteId` es obligatorio (FK a Cliente)
- `imei` debe ser √∫nico si se proporciona (algunos equipos viejos no tienen)
- `patron` y `observaciones` pueden ser textos largos
- `onDelete: Cascade` para que al eliminar un cliente se eliminen sus equipos
- √çndice en `clienteId` para b√∫squedas r√°pidas de equipos por cliente

### 3. Crear Seeds de Clientes de Prueba
**Archivo:** `prisma/seed.ts` (o ampliar si ya existe)

Implementar funci√≥n para crear clientes con diferentes perfiles:

#### a) Clientes VIP (2-3 clientes)
Clientes con alto volumen de √≥rdenes (>10) o ticket promedio alto:

```typescript
// Ejemplo de cliente VIP
{
  nombre: "Roberto",
  apellido: "Gonz√°lez Garc√≠a",
  telefono: "5551234567",
  telefonoAlterno: "5559876543",
  email: "roberto.gonzalez@email.com",
  direccion: "Av. Principal #123, Col. Centro",
  notas: "Cliente VIP - Due√±o de tienda de celulares. Siempre paga en efectivo. Prefiere refacciones originales."
}
```

#### b) Clientes Frecuentes (3-4 clientes)
Clientes con historial medio (5-10 √≥rdenes):

```typescript
{
  nombre: "Mar√≠a",
  apellido: "L√≥pez Hern√°ndez",
  telefono: "5552345678",
  email: "maria.lopez@email.com",
  direccion: "Calle 5 #45, Col. San Jos√©",
  notas: "Cliente frecuente. Trae equipos de su familia."
}
```

#### c) Clientes Nuevos (5-6 clientes)
Clientes con pocas √≥rdenes (1-3):

```typescript
{
  nombre: "Juan",
  apellido: "P√©rez Mart√≠nez",
  telefono: "5553456789",
  email: null, // Algunos clientes no tienen email
  direccion: null,
  notas: "Cliente nuevo. Primera visita."
}
```

#### d) Casos Especiales para Testing
```typescript
// Cliente sin email (solo tel√©fono)
{
  nombre: "Pedro",
  apellido: "Ram√≠rez",
  telefono: "5554567890",
  email: null,
  notas: "Prefiere comunicaci√≥n por WhatsApp"
}

// Cliente con tel√©fono alterno
{
  nombre: "Ana",
  apellido: "Mart√≠nez Soto",
  telefono: "5555678901",
  telefonoAlterno: "5556789012",
  email: "ana.martinez@email.com",
  notas: "Llamar primero al tel√©fono alterno (trabajo)"
}

// Cliente con muchas notas
{
  nombre: "Carlos",
  apellido: "Hern√°ndez Cruz",
  telefono: "5556789012",
  email: "carlos.hdz@email.com",
  notas: "Cliente exigente. Siempre quiere garant√≠a extendida. Ha tenido problemas con reparaciones anteriores en otros talleres. Prefiere que le expliquen todo detalladamente."
}
```

**Total de clientes a crear:** 10-12 clientes variados

### 4. Crear Seeds de Equipos de Prueba
**Archivo:** `prisma/seed.ts`

Crear equipos asociados a los clientes creados, representando diferentes escenarios:

#### a) Variedad de Marcas y Modelos
```typescript
const equipos = [
  // iPhones
  { marca: "Apple", modelo: "iPhone 13 Pro", imei: "353456789012345", color: "Azul Sierra" },
  { marca: "Apple", modelo: "iPhone 12", imei: "353456789012346", color: "Negro" },
  { marca: "Apple", modelo: "iPhone 11", imei: "353456789012347", color: "Blanco" },
  { marca: "Apple", modelo: "iPhone XR", imei: "353456789012348", color: "Rojo" },
  
  // Samsung
  { marca: "Samsung", modelo: "Galaxy S21", imei: "353456789012349", color: "Gris Fantasma" },
  { marca: "Samsung", modelo: "Galaxy A52", imei: "353456789012350", color: "Negro" },
  { marca: "Samsung", modelo: "Galaxy A32", imei: "353456789012351", color: "Azul" },
  
  // Xiaomi
  { marca: "Xiaomi", modelo: "Redmi Note 10 Pro", imei: "353456789012352", color: "Gris Grafito" },
  { marca: "Xiaomi", modelo: "Redmi 9", imei: "353456789012353", color: "Verde" },
  { marca: "Xiaomi", modelo: "Poco X3 Pro", imei: "353456789012354", color: "Azul Escarcha" },
  
  // Motorola
  { marca: "Motorola", modelo: "Moto G Power", imei: "353456789012355", color: "Plata" },
  { marca: "Motorola", modelo: "Moto E7", imei: "353456789012356", color: "Negro" },
  
  // Huawei
  { marca: "Huawei", modelo: "P30 Lite", imei: "353456789012357", color: "Azul Pavo Real" },
  
  // LG
  { marca: "LG", modelo: "K41S", imei: "353456789012358", color: "Gris Titanio" },
  
  // Casos especiales
  { marca: "Apple", modelo: "iPhone 7", imei: null, color: "Negro", 
    observaciones: "Equipo antiguo sin IMEI visible" },
  { marca: "Samsung", modelo: "Galaxy J7", imei: null, color: "Dorado",
    observaciones: "IMEI ilegible por desgaste" }
];
```

#### b) Asociar Equipos a Clientes
```typescript
// Cliente VIP con m√∫ltiples equipos
// Roberto Gonz√°lez -> 3 equipos (iPhone 13 Pro, Galaxy S21, iPhone XR)

// Cliente Frecuente con 2 equipos
// Mar√≠a L√≥pez -> 2 equipos (Redmi Note 10 Pro, Moto G Power)

// Clientes Nuevos con 1 equipo cada uno
// Juan P√©rez -> iPhone 12
// Pedro Ram√≠rez -> Galaxy A52
// Ana Mart√≠nez -> iPhone 11
// etc.
```

#### c) Equipos con Observaciones Especiales
```typescript
{
  marca: "Apple",
  modelo: "iPhone 13 Pro",
  imei: "353456789012345",
  color: "Azul Sierra",
  patron: "Patr√≥n: 1-4-7-8-5-2",
  observaciones: "Tiene rasp√≥n en esquina superior derecha. Fundas de cuero caf√©."
}

{
  marca: "Samsung",
  modelo: "Galaxy S21",
  imei: "353456789012349",
  color: "Gris Fantasma",
  patron: null,
  observaciones: "Usa huella digital. Tiene mica de vidrio instalada. Cargador inal√°mbrico."
}
```

**Total de equipos a crear:** 20-25 equipos distribuidos entre los clientes

### 5. Implementar Queries Optimizadas

Aunque no se implementan funciones en Prisma directamente, documentar las queries que el backend deber√° usar:

#### a) B√∫squeda de Cliente por Tel√©fono (normalizado)
```typescript
// El backend deber√° normalizar el tel√©fono antes de buscar
// Ejemplo: "(555) 123-4567" -> "5551234567"
await prisma.cliente.findUnique({
  where: { telefono: telefonoNormalizado },
  include: {
    equipos: true,
    ordenes: {
      orderBy: { createdAt: 'desc' },
      take: 5
    }
  }
});
```

#### b) B√∫squeda de Cliente por Nombre (parcial)
```typescript
await prisma.cliente.findMany({
  where: {
    OR: [
      { nombre: { contains: query, mode: 'insensitive' } },
      { apellido: { contains: query, mode: 'insensitive' } },
      { telefono: { contains: query } }
    ]
  },
  include: {
    _count: {
      select: { ordenes: true, equipos: true }
    }
  },
  orderBy: { createdAt: 'desc' }
});
```

#### c) B√∫squeda de Equipo por IMEI
```typescript
await prisma.equipo.findUnique({
  where: { imei: imeiQuery },
  include: {
    cliente: true,
    ordenes: {
      orderBy: { createdAt: 'desc' }
    }
  }
});
```

#### d) Obtener Equipos de un Cliente
```typescript
await prisma.equipo.findMany({
  where: { clienteId: clienteId },
  orderBy: { createdAt: 'desc' }
});
```

#### e) Detectar Clientes Duplicados
```typescript
// Por tel√©fono similar
await prisma.cliente.findMany({
  where: {
    telefono: {
      contains: telefonoBase // Buscar variaciones
    }
  }
});

// Por nombre similar (esto requerir√° l√≥gica adicional en el backend)
// Usar algoritmo de Levenshtein distance
```

### 6. Crear √çndices Adicionales para Performance

Verificar que existen estos √≠ndices en el schema:

```prisma
// En modelo Cliente
@@index([telefono]) // B√∫squeda exacta por tel√©fono (m√°s com√∫n)
@@index([nombre, apellido]) // B√∫squeda combinada por nombre completo
@@index([email]) // B√∫squeda por email
@@index([createdAt]) // Para ordenar por fecha de registro

// En modelo Equipo
@@index([clienteId]) // Para listar equipos de un cliente (muy com√∫n)
@@index([imei]) // Para b√∫squeda por IMEI
@@index([marca, modelo]) // Para filtrar por marca/modelo
```

### 7. Crear Migraci√≥n Espec√≠fica

Si el schema fue modificado:

```bash
npx prisma migrate dev --name add_clientes_equipos_indices
```

### 8. Ejecutar Seeds

```bash
npx prisma db seed
```

Luego verificar con Prisma Studio:
```bash
npx prisma studio
```

## Criterios de √âxito

‚úÖ El modelo `Cliente` est√° completo con todos los campos requeridos
‚úÖ El modelo `Equipo` est√° completo con relaci√≥n correcta a Cliente
‚úÖ Los √≠ndices est√°n creados en campos de b√∫squeda frecuente
‚úÖ El seed crea al menos:
  - 10-12 clientes con perfiles variados (VIP, Frecuente, Nuevo)
  - 20-25 equipos asociados a los clientes
  - Variedad de marcas: Apple, Samsung, Xiaomi, Motorola, Huawei, LG
  - Casos especiales: equipos sin IMEI, con observaciones, con patr√≥n

‚úÖ La relaci√≥n 1:N entre Cliente ‚Üí Equipos funciona correctamente
‚úÖ La b√∫squeda por tel√©fono es eficiente (√≠ndice aplicado)
‚úÖ La b√∫squeda por nombre/apellido es eficiente (√≠ndice aplicado)
‚úÖ Se puede eliminar un cliente y sus equipos se eliminan en cascada
‚úÖ No se pueden crear dos clientes con el mismo tel√©fono
‚úÖ No se pueden crear dos equipos con el mismo IMEI (si tienen IMEI)

## Comandos de Verificaci√≥n

```bash
# Verificar el schema
npx prisma format
npx prisma validate

# Ver los datos creados
npx prisma studio

# Ejecutar una query de prueba
npx prisma db execute --stdin <<EOF
SELECT c.nombre, c.apellido, c.telefono, COUNT(e.id) as total_equipos
FROM clientes c
LEFT JOIN equipos e ON e."clienteId" = c.id
GROUP BY c.id
ORDER BY total_equipos DESC;
EOF

# Verificar √≠ndices creados
npx prisma db execute --stdin <<EOF
SELECT tablename, indexname, indexdef
FROM pg_indexes
WHERE tablename IN ('clientes', 'equipos')
ORDER BY tablename, indexname;
EOF
```

## Notas Importantes

1. **Normalizaci√≥n de Tel√©fonos:** 
   - Siempre almacenar tel√©fonos sin formato (solo n√∫meros)
   - Ejemplo: "555-123-4567" ‚Üí "5551234567"
   - El formato se aplica solo en la UI

2. **Unicidad de Tel√©fono:**
   - El tel√©fono es el identificador principal del cliente
   - Validar en backend antes de crear

3. **IMEI Opcional:**
   - Algunos equipos antiguos no tienen IMEI legible
   - Permitir NULL pero si existe debe ser √∫nico

4. **Eliminaci√≥n en Cascada:**
   - Al eliminar un cliente, sus equipos se eliminan
   - ADVERTIR al usuario antes de eliminar

5. **B√∫squedas Case-Insensitive:**
   - Usar `mode: 'insensitive'` en Prisma para b√∫squedas
   - PostgreSQL soporta esto nativamente

6. **Performance:**
   - Con √≠ndices, la b√∫squeda debe ser <100ms para hasta 10,000 clientes
   - Monitorear con `EXPLAIN ANALYZE` si hay lentitud

## Problemas Comunes y Soluciones

**Error: "Unique constraint failed on telefono"**
- Soluci√≥n: Verificar que no exista el tel√©fono antes de crear
- Implementar b√∫squeda previa en el backend

**Error: "Foreign key constraint failed"**
- Soluci√≥n: Verificar que el clienteId existe antes de crear un equipo
- Usar transacciones para crear cliente + equipo juntos

**B√∫squedas lentas por nombre**
- Soluci√≥n: Verificar que existe el √≠ndice compuesto [nombre, apellido]
- Considerar usar full-text search si el problema persiste

**Equipos no se eliminan al borrar cliente**
- Soluci√≥n: Verificar que `onDelete: Cascade` est√© configurado
- Regenerar migraci√≥n si es necesario

## Entregables

1. ‚úÖ Modelos `Cliente` y `Equipo` completos en `prisma/schema.prisma`
2. ‚úÖ √çndices optimizados para b√∫squedas
3. ‚úÖ Seeds con 10-12 clientes variados
4. ‚úÖ Seeds con 20-25 equipos asociados
5. ‚úÖ Migraci√≥n aplicada exitosamente
6. ‚úÖ Documentaci√≥n de queries recomendadas
7. ‚úÖ Verificaci√≥n con Prisma Studio

## Siguiente Paso

Una vez completado este agente, el siguiente es:
üëâ **01.3-db-ordenes-presupuestos.md** - Implementar tablas de √≥rdenes, presupuestos e historial de estados

## Referencias
- Documentaci√≥n Prisma Relations: https://www.prisma.io/docs/concepts/components/prisma-schema/relations
- Documentaci√≥n Prisma Indexes: https://www.prisma.io/docs/concepts/components/prisma-schema/indexes
- Schema de referencia: `/docs/FSD.md` secci√≥n 3.1
- Requerimientos de clientes: `/docs/SRS.md` secci√≥n 3.2
