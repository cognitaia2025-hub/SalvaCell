# Agent: Presupuestos Backend

## Instrucci√≥n de Idioma
**IMPORTANTE:** Todos los procesos, informes, commits, y documentaci√≥n generados por este agente deben realizarse en espa√±ol hispanohablante para facilitar la comprensi√≥n del equipo.

## Rol
Ingeniero Backend especializado en desarrollo de APIs REST, l√≥gica de negocio y automatizaci√≥n de procesos.

## Objetivo
Implementar el m√≥dulo completo de gesti√≥n de presupuestos en el backend, incluyendo CRUD, generaci√≥n autom√°tica de folios con formato PRE-{YYYY}{MM}{###}, conversi√≥n de presupuesto a orden, gesti√≥n de estados (PENDIENTE/ACEPTADO/RECHAZADO/VENCIDO), c√°lculo autom√°tico de fechas de vencimiento y funcionalidad de env√≠o por WhatsApp.

## Contexto del Proyecto
SalvaCell requiere un sistema de presupuestos que permita:
- Crear cotizaciones r√°pidas para clientes
- Generar folios √∫nicos y secuenciales por mes
- Convertir presupuestos aceptados en √≥rdenes de trabajo
- Gestionar el ciclo de vida del presupuesto (estados y vencimientos)
- Enviar presupuestos por WhatsApp con plantillas personalizadas

## Documentaci√≥n de Referencia
Revisar los siguientes documentos en la carpeta `/home/runner/work/SalvaCell/SalvaCell/docs/`:
- `FSD.md` - Secci√≥n 3.1 (Modelo Presupuesto) y Secci√≥n 4.3 (API Endpoints)
- `SRS.md` - Secci√≥n 3.3 (Gesti√≥n de Presupuestos) - RF-PRE-001 a RF-PRE-004
- `PRD.md` - Historias de usuario US-PRES-001 y US-PRES-002
- `BRD.md` - Requisitos de negocio para presupuestos

## Pre-requisitos
‚úÖ El agente `01-database-architect` debe haber completado:
  - Modelo Presupuesto en Prisma
  - Enum EstadoPresupuesto
  - Relaciones con Cliente, Equipo y Orden

‚úÖ El agente `02-backend-setup` debe haber completado:
  - Proyecto Express configurado
  - Estructura base de carpetas

‚úÖ El agente `04.1-clientes-backend` debe haber completado:
  - API de clientes funcionando

## Tareas Espec√≠ficas

### 1. Crear Validadores con Zod

**Archivo:** `backend/src/validators/presupuesto.validator.ts`

```typescript
import { z } from 'zod';

export const createPresupuestoSchema = z.object({
  clienteId: z.string().uuid({ message: 'ID de cliente inv√°lido' }),
  equipoId: z.string().uuid({ message: 'ID de equipo inv√°lido' }).optional().nullable(),
  descripcionProblema: z.string()
    .min(10, { message: 'La descripci√≥n debe tener al menos 10 caracteres' })
    .max(1000, { message: 'La descripci√≥n no puede exceder 1000 caracteres' }),
  montoEstimado: z.number()
    .positive({ message: 'El monto debe ser positivo' })
    .max(999999.99, { message: 'El monto excede el l√≠mite' }),
  vigenciaDias: z.number()
    .int()
    .min(1)
    .max(90)
    .default(15),
  observaciones: z.string().max(500).optional().nullable(),
});

export const updatePresupuestoSchema = createPresupuestoSchema.partial();

export const cambiarEstadoSchema = z.object({
  estado: z.enum(['ACEPTADO', 'RECHAZADO'], {
    message: 'Estado inv√°lido. Debe ser ACEPTADO o RECHAZADO',
  }),
  observaciones: z.string().max(500).optional(),
});

export const searchPresupuestoSchema = z.object({
  estado: z.enum(['PENDIENTE', 'ACEPTADO', 'RECHAZADO', 'VENCIDO']).optional(),
  clienteId: z.string().uuid().optional(),
  fechaDesde: z.string().datetime().optional(),
  fechaHasta: z.string().datetime().optional(),
  page: z.coerce.number().min(1).default(1),
  limit: z.coerce.number().min(1).max(100).default(20),
});

export type CreatePresupuestoInput = z.infer<typeof createPresupuestoSchema>;
export type UpdatePresupuestoInput = z.infer<typeof updatePresupuestoSchema>;
export type CambiarEstadoInput = z.infer<typeof cambiarEstadoSchema>;
export type SearchPresupuestoInput = z.infer<typeof searchPresupuestoSchema>;
```

### 2. Crear Utilidades para Presupuestos

**Archivo:** `backend/src/utils/presupuesto.util.ts`

```typescript
import prisma from '../config/database';

/**
 * Genera el siguiente folio de presupuesto en formato PRE-{YYYY}{MM}{###}
 * Ejemplo: PRE-202601001, PRE-202601002, etc.
 */
export async function generarFolioPresupuesto(): Promise<string> {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const prefix = `PRE-${year}${month}`;
  
  // Buscar el √∫ltimo folio del mes actual
  const ultimoPresupuesto = await prisma.presupuesto.findFirst({
    where: {
      folio: {
        startsWith: prefix,
      },
    },
    orderBy: {
      folio: 'desc',
    },
  });
  
  let numeroSecuencial = 1;
  
  if (ultimoPresupuesto) {
    // Extraer el n√∫mero secuencial del √∫ltimo folio
    const ultimoNumero = parseInt(ultimoPresupuesto.folio.slice(-3));
    numeroSecuencial = ultimoNumero + 1;
  }
  
  // Formatear con 3 d√≠gitos (001, 002, ..., 999)
  const numeroFormateado = String(numeroSecuencial).padStart(3, '0');
  
  return `${prefix}${numeroFormateado}`;
}

/**
 * Calcula la fecha de vencimiento del presupuesto
 */
export function calcularFechaVencimiento(vigenciaDias: number): Date {
  const fecha = new Date();
  fecha.setDate(fecha.getDate() + vigenciaDias);
  return fecha;
}

/**
 * Verifica si un presupuesto est√° vencido
 */
export function estaVencido(fechaVencimiento: Date): boolean {
  return new Date() > new Date(fechaVencimiento);
}

/**
 * Genera el mensaje de WhatsApp para un presupuesto
 */
export function generarMensajeWhatsApp(
  nombreCliente: string,
  folio: string,
  descripcion: string,
  monto: number,
  vigenciaDias: number
): string {
  const mensaje = `Hola ${nombreCliente},

Te enviamos el presupuesto para la reparaci√≥n de tu equipo:

üìã Folio: ${folio}
üîß Problema: ${descripcion}
üí∞ Costo estimado: $${monto.toFixed(2)}
üìÖ Vigencia: ${vigenciaDias} d√≠as

Para continuar con la reparaci√≥n, por favor confirma tu aceptaci√≥n.

¬°Gracias por tu preferencia!
SalvaCell`;

  return mensaje;
}

/**
 * Codifica un mensaje para URL de WhatsApp
 */
export function generarEnlaceWhatsApp(telefono: string, mensaje: string): string {
  const telefonoLimpio = telefono.replace(/[^0-9]/g, '');
  const mensajeCodificado = encodeURIComponent(mensaje);
  return `https://wa.me/${telefonoLimpio}?text=${mensajeCodificado}`;
}
```

### 3. Crear Servicio de Presupuestos

**Archivo:** `backend/src/services/presupuesto.service.ts`

```typescript
import { BaseService } from './base.service';
import { 
  CreatePresupuestoInput, 
  UpdatePresupuestoInput,
  CambiarEstadoInput,
  SearchPresupuestoInput
} from '../validators/presupuesto.validator';
import { 
  generarFolioPresupuesto,
  calcularFechaVencimiento,
  estaVencido,
  generarMensajeWhatsApp,
  generarEnlaceWhatsApp
} from '../utils/presupuesto.util';

export class PresupuestoService extends BaseService {
  
  /**
   * Obtener lista de presupuestos con filtros
   */
  async getPresupuestos(params: SearchPresupuestoInput) {
    try {
      const { estado, clienteId, fechaDesde, fechaHasta, page, limit } = params;
      const skip = (page - 1) * limit;
      
      // Construir condiciones de filtro
      const whereConditions: any = {};
      
      if (estado) {
        whereConditions.estado = estado;
      }
      
      if (clienteId) {
        whereConditions.clienteId = clienteId;
      }
      
      if (fechaDesde || fechaHasta) {
        whereConditions.createdAt = {};
        if (fechaDesde) {
          whereConditions.createdAt.gte = new Date(fechaDesde);
        }
        if (fechaHasta) {
          whereConditions.createdAt.lte = new Date(fechaHasta);
        }
      }
      
      // Obtener presupuestos
      const [presupuestos, total] = await Promise.all([
        this.prisma.presupuesto.findMany({
          where: whereConditions,
          include: {
            cliente: {
              select: {
                id: true,
                nombre: true,
                apellido: true,
                telefono: true,
              },
            },
            equipo: {
              select: {
                id: true,
                marca: true,
                modelo: true,
              },
            },
            orden: {
              select: {
                id: true,
                folio: true,
                estado: true,
              },
            },
          },
          skip,
          take: limit,
          orderBy: {
            createdAt: 'desc',
          },
        }),
        this.prisma.presupuesto.count({ where: whereConditions }),
      ]);
      
      // Actualizar estado a VENCIDO si corresponde
      const presupuestosActualizados = await Promise.all(
        presupuestos.map(async (presupuesto) => {
          if (
            presupuesto.estado === 'PENDIENTE' &&
            estaVencido(presupuesto.fechaVencimiento)
          ) {
            // Actualizar a vencido
            const actualizado = await this.prisma.presupuesto.update({
              where: { id: presupuesto.id },
              data: { estado: 'VENCIDO' },
              include: {
                cliente: {
                  select: {
                    id: true,
                    nombre: true,
                    apellido: true,
                    telefono: true,
                  },
                },
                equipo: {
                  select: {
                    id: true,
                    marca: true,
                    modelo: true,
                  },
                },
                orden: {
                  select: {
                    id: true,
                    folio: true,
                    estado: true,
                  },
                },
              },
            });
            return actualizado;
          }
          return presupuesto;
        })
      );
      
      return {
        presupuestos: presupuestosActualizados,
        pagination: {
          page,
          limit,
          total,
          totalPages: Math.ceil(total / limit),
        },
      };
    } catch (error) {
      this.handleError(error);
    }
  }
  
  /**
   * Obtener presupuesto por ID
   */
  async getPresupuestoById(id: string) {
    try {
      const presupuesto = await this.prisma.presupuesto.findUnique({
        where: { id },
        include: {
          cliente: true,
          equipo: true,
          orden: {
            include: {
              equipo: true,
            },
          },
        },
      });
      
      if (!presupuesto) {
        throw new Error('Presupuesto no encontrado');
      }
      
      // Verificar si est√° vencido y actualizar
      if (
        presupuesto.estado === 'PENDIENTE' &&
        estaVencido(presupuesto.fechaVencimiento)
      ) {
        const actualizado = await this.prisma.presupuesto.update({
          where: { id },
          data: { estado: 'VENCIDO' },
          include: {
            cliente: true,
            equipo: true,
            orden: {
              include: {
                equipo: true,
              },
            },
          },
        });
        return actualizado;
      }
      
      return presupuesto;
    } catch (error) {
      this.handleError(error);
    }
  }
  
  /**
   * Crear nuevo presupuesto
   */
  async createPresupuesto(data: CreatePresupuestoInput) {
    try {
      // Verificar que el cliente existe
      const cliente = await this.prisma.cliente.findUnique({
        where: { id: data.clienteId },
      });
      
      if (!cliente) {
        throw new Error('Cliente no encontrado');
      }
      
      // Si se proporciona equipoId, verificar que existe
      if (data.equipoId) {
        const equipo = await this.prisma.equipo.findUnique({
          where: { id: data.equipoId },
        });
        
        if (!equipo) {
          throw new Error('Equipo no encontrado');
        }
        
        // Verificar que el equipo pertenece al cliente
        if (equipo.clienteId !== data.clienteId) {
          throw new Error('El equipo no pertenece al cliente especificado');
        }
      }
      
      // Generar folio autom√°tico
      const folio = await generarFolioPresupuesto();
      
      // Calcular fecha de vencimiento
      const fechaVencimiento = calcularFechaVencimiento(data.vigenciaDias || 15);
      
      // Crear presupuesto
      const presupuesto = await this.prisma.presupuesto.create({
        data: {
          folio,
          clienteId: data.clienteId,
          equipoId: data.equipoId || null,
          descripcionProblema: data.descripcionProblema,
          montoEstimado: data.montoEstimado,
          vigenciaDias: data.vigenciaDias || 15,
          fechaVencimiento,
          observaciones: data.observaciones || null,
        },
        include: {
          cliente: true,
          equipo: true,
        },
      });
      
      return presupuesto;
    } catch (error) {
      this.handleError(error);
    }
  }
  
  /**
   * Actualizar presupuesto
   */
  async updatePresupuesto(id: string, data: UpdatePresupuestoInput) {
    try {
      // Verificar que el presupuesto existe
      const presupuestoExistente = await this.prisma.presupuesto.findUnique({
        where: { id },
      });
      
      if (!presupuestoExistente) {
        throw new Error('Presupuesto no encontrado');
      }
      
      // No permitir editar presupuestos aceptados o con orden generada
      if (presupuestoExistente.estado === 'ACEPTADO') {
        throw new Error('No se puede editar un presupuesto aceptado');
      }
      
      // Si se cambia vigenciaDias, recalcular fechaVencimiento
      let fechaVencimiento = presupuestoExistente.fechaVencimiento;
      if (data.vigenciaDias && data.vigenciaDias !== presupuestoExistente.vigenciaDias) {
        fechaVencimiento = calcularFechaVencimiento(data.vigenciaDias);
      }
      
      // Actualizar presupuesto
      const presupuesto = await this.prisma.presupuesto.update({
        where: { id },
        data: {
          ...data,
          fechaVencimiento,
        },
        include: {
          cliente: true,
          equipo: true,
        },
      });
      
      return presupuesto;
    } catch (error) {
      this.handleError(error);
    }
  }
  
  /**
   * Cambiar estado del presupuesto (ACEPTADO/RECHAZADO)
   */
  async cambiarEstado(id: string, data: CambiarEstadoInput) {
    try {
      const presupuesto = await this.prisma.presupuesto.findUnique({
        where: { id },
      });
      
      if (!presupuesto) {
        throw new Error('Presupuesto no encontrado');
      }
      
      // Validar que el presupuesto est√© en estado PENDIENTE
      if (presupuesto.estado !== 'PENDIENTE') {
        throw new Error(
          `No se puede cambiar el estado de un presupuesto ${presupuesto.estado.toLowerCase()}`
        );
      }
      
      // Actualizar estado
      const actualizado = await this.prisma.presupuesto.update({
        where: { id },
        data: {
          estado: data.estado,
          observaciones: data.observaciones || presupuesto.observaciones,
        },
        include: {
          cliente: true,
          equipo: true,
        },
      });
      
      return actualizado;
    } catch (error) {
      this.handleError(error);
    }
  }
  
  /**
   * Convertir presupuesto a orden
   */
  async convertirAOrden(presupuestoId: string) {
    try {
      const presupuesto = await this.prisma.presupuesto.findUnique({
        where: { id: presupuestoId },
        include: {
          cliente: true,
          equipo: true,
        },
      });
      
      if (!presupuesto) {
        throw new Error('Presupuesto no encontrado');
      }
      
      // Validar que el presupuesto est√© ACEPTADO
      if (presupuesto.estado !== 'ACEPTADO') {
        throw new Error('Solo se pueden convertir presupuestos aceptados');
      }
      
      // Verificar que no tenga ya una orden asociada
      const ordenExistente = await this.prisma.orden.findFirst({
        where: { presupuestoId: presupuestoId },
      });
      
      if (ordenExistente) {
        throw new Error('Este presupuesto ya tiene una orden asociada');
      }
      
      // Si no tiene equipo, lanzar error
      if (!presupuesto.equipoId) {
        throw new Error('El presupuesto debe tener un equipo asociado para crear una orden');
      }
      
      // Generar folio de orden (importar funci√≥n del servicio de √≥rdenes)
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const prefix = `ORD-${year}${month}`;
      
      const ultimaOrden = await this.prisma.orden.findFirst({
        where: {
          folio: {
            startsWith: prefix,
          },
        },
        orderBy: {
          folio: 'desc',
        },
      });
      
      let numeroSecuencial = 1;
      if (ultimaOrden) {
        const ultimoNumero = parseInt(ultimaOrden.folio.slice(-3));
        numeroSecuencial = ultimoNumero + 1;
      }
      
      const folioOrden = `${prefix}${String(numeroSecuencial).padStart(3, '0')}`;
      
      // Calcular fecha estimada de entrega (7 d√≠as por defecto)
      const fechaEstimadaEntrega = new Date();
      fechaEstimadaEntrega.setDate(fechaEstimadaEntrega.getDate() + 7);
      
      // Crear orden en una transacci√≥n
      const orden = await this.prisma.$transaction(async (tx) => {
        // Crear la orden
        const nuevaOrden = await tx.orden.create({
          data: {
            folio: folioOrden,
            clienteId: presupuesto.clienteId,
            equipoId: presupuesto.equipoId!,
            presupuestoId: presupuestoId,
            problemaReportado: presupuesto.descripcionProblema,
            tipoReparacion: 'Por determinar',
            estado: 'RECIBIDO',
            prioridad: 'NORMAL',
            costoTotal: presupuesto.montoEstimado,
            anticipo: 0,
            adeudo: presupuesto.montoEstimado,
            fechaEstimadaEntrega,
          },
          include: {
            cliente: true,
            equipo: true,
            presupuesto: true,
          },
        });
        
        // Crear el primer registro en el historial de estados
        await tx.historialEstadoOrden.create({
          data: {
            ordenId: nuevaOrden.id,
            estadoAnterior: null,
            estadoNuevo: 'RECIBIDO',
            notas: `Orden creada a partir del presupuesto ${presupuesto.folio}`,
          },
        });
        
        return nuevaOrden;
      });
      
      return orden;
    } catch (error) {
      this.handleError(error);
    }
  }
  
  /**
   * Generar enlace de WhatsApp para enviar presupuesto
   */
  async generarEnlaceWhatsApp(presupuestoId: string) {
    try {
      const presupuesto = await this.getPresupuestoById(presupuestoId);
      
      if (!presupuesto) {
        throw new Error('Presupuesto no encontrado');
      }
      
      const nombreCompleto = `${presupuesto.cliente.nombre} ${presupuesto.cliente.apellido}`;
      
      const mensaje = generarMensajeWhatsApp(
        nombreCompleto,
        presupuesto.folio,
        presupuesto.descripcionProblema,
        Number(presupuesto.montoEstimado),
        presupuesto.vigenciaDias
      );
      
      const enlace = generarEnlaceWhatsApp(presupuesto.cliente.telefono, mensaje);
      
      // Registrar el env√≠o
      await this.prisma.presupuesto.update({
        where: { id: presupuestoId },
        data: {
          medioEnvio: 'WhatsApp',
          fechaEnvio: new Date(),
        },
      });
      
      return {
        enlace,
        mensaje,
        telefono: presupuesto.cliente.telefono,
      };
    } catch (error) {
      this.handleError(error);
    }
  }
  
  /**
   * Eliminar presupuesto (solo si est√° en estado PENDIENTE o RECHAZADO)
   */
  async deletePresupuesto(id: string) {
    try {
      const presupuesto = await this.prisma.presupuesto.findUnique({
        where: { id },
      });
      
      if (!presupuesto) {
        throw new Error('Presupuesto no encontrado');
      }
      
      // No permitir eliminar presupuestos aceptados
      if (presupuesto.estado === 'ACEPTADO') {
        throw new Error('No se puede eliminar un presupuesto aceptado');
      }
      
      await this.prisma.presupuesto.delete({
        where: { id },
      });
      
      return { message: 'Presupuesto eliminado exitosamente' };
    } catch (error) {
      this.handleError(error);
    }
  }
}
```

### 4. Crear Controlador de Presupuestos

**Archivo:** `backend/src/controllers/presupuesto.controller.ts`

```typescript
import { Request, Response } from 'express';
import { BaseController } from './base.controller';
import { PresupuestoService } from '../services/presupuesto.service';
import {
  createPresupuestoSchema,
  updatePresupuestoSchema,
  cambiarEstadoSchema,
  searchPresupuestoSchema,
} from '../validators/presupuesto.validator';

export class PresupuestoController extends BaseController {
  private presupuestoService = new PresupuestoService();
  
  /**
   * GET /api/presupuestos
   */
  getPresupuestos = this.asyncHandler(async (req: Request, res: Response) => {
    const params = searchPresupuestoSchema.parse({
      estado: req.query.estado,
      clienteId: req.query.clienteId,
      fechaDesde: req.query.fechaDesde,
      fechaHasta: req.query.fechaHasta,
      page: req.query.page,
      limit: req.query.limit,
    });
    
    const result = await this.presupuestoService.getPresupuestos(params);
    
    return this.sendSuccess(res, result, 'Presupuestos obtenidos exitosamente');
  });
  
  /**
   * GET /api/presupuestos/:id
   */
  getPresupuestoById = this.asyncHandler(async (req: Request, res: Response) => {
    const { id } = req.params;
    
    const result = await this.presupuestoService.getPresupuestoById(id);
    
    return this.sendSuccess(res, result, 'Presupuesto obtenido exitosamente');
  });
  
  /**
   * POST /api/presupuestos
   */
  createPresupuesto = this.asyncHandler(async (req: Request, res: Response) => {
    const validatedData = createPresupuestoSchema.parse(req.body);
    
    const result = await this.presupuestoService.createPresupuesto(validatedData);
    
    return this.sendSuccess(res, result, 'Presupuesto creado exitosamente', 201);
  });
  
  /**
   * PUT /api/presupuestos/:id
   */
  updatePresupuesto = this.asyncHandler(async (req: Request, res: Response) => {
    const { id } = req.params;
    const validatedData = updatePresupuestoSchema.parse(req.body);
    
    const result = await this.presupuestoService.updatePresupuesto(id, validatedData);
    
    return this.sendSuccess(res, result, 'Presupuesto actualizado exitosamente');
  });
  
  /**
   * PATCH /api/presupuestos/:id/estado
   */
  cambiarEstado = this.asyncHandler(async (req: Request, res: Response) => {
    const { id } = req.params;
    const validatedData = cambiarEstadoSchema.parse(req.body);
    
    const result = await this.presupuestoService.cambiarEstado(id, validatedData);
    
    return this.sendSuccess(res, result, 'Estado actualizado exitosamente');
  });
  
  /**
   * POST /api/presupuestos/:id/convertir-orden
   */
  convertirAOrden = this.asyncHandler(async (req: Request, res: Response) => {
    const { id } = req.params;
    
    const result = await this.presupuestoService.convertirAOrden(id);
    
    return this.sendSuccess(res, result, 'Orden creada exitosamente', 201);
  });
  
  /**
   * GET /api/presupuestos/:id/whatsapp
   */
  generarEnlaceWhatsApp = this.asyncHandler(async (req: Request, res: Response) => {
    const { id } = req.params;
    
    const result = await this.presupuestoService.generarEnlaceWhatsApp(id);
    
    return this.sendSuccess(res, result, 'Enlace generado exitosamente');
  });
  
  /**
   * DELETE /api/presupuestos/:id
   */
  deletePresupuesto = this.asyncHandler(async (req: Request, res: Response) => {
    const { id } = req.params;
    
    const result = await this.presupuestoService.deletePresupuesto(id);
    
    return this.sendSuccess(res, result, 'Presupuesto eliminado exitosamente');
  });
}
```

### 5. Crear Rutas de Presupuestos

**Archivo:** `backend/src/routes/presupuesto.routes.ts`

```typescript
import { Router } from 'express';
import { PresupuestoController } from '../controllers/presupuesto.controller';
import { authenticate } from '../middleware/auth.middleware';
import { authorize } from '../middleware/rbac.middleware';

const router = Router();
const presupuestoController = new PresupuestoController();

// Todas las rutas requieren autenticaci√≥n
router.use(authenticate);

// GET /api/presupuestos - Listar presupuestos (todos los roles)
router.get('/', presupuestoController.getPresupuestos);

// GET /api/presupuestos/:id - Obtener presupuesto por ID (todos los roles)
router.get('/:id', presupuestoController.getPresupuestoById);

// POST /api/presupuestos - Crear presupuesto (ADMIN y RECEPCIONISTA)
router.post(
  '/',
  authorize('ADMIN', 'RECEPCIONISTA'),
  presupuestoController.createPresupuesto
);

// PUT /api/presupuestos/:id - Actualizar presupuesto (ADMIN y RECEPCIONISTA)
router.put(
  '/:id',
  authorize('ADMIN', 'RECEPCIONISTA'),
  presupuestoController.updatePresupuesto
);

// PATCH /api/presupuestos/:id/estado - Cambiar estado (ADMIN y RECEPCIONISTA)
router.patch(
  '/:id/estado',
  authorize('ADMIN', 'RECEPCIONISTA'),
  presupuestoController.cambiarEstado
);

// POST /api/presupuestos/:id/convertir-orden - Convertir a orden (ADMIN y RECEPCIONISTA)
router.post(
  '/:id/convertir-orden',
  authorize('ADMIN', 'RECEPCIONISTA'),
  presupuestoController.convertirAOrden
);

// GET /api/presupuestos/:id/whatsapp - Generar enlace WhatsApp (ADMIN y RECEPCIONISTA)
router.get(
  '/:id/whatsapp',
  authorize('ADMIN', 'RECEPCIONISTA'),
  presupuestoController.generarEnlaceWhatsApp
);

// DELETE /api/presupuestos/:id - Eliminar presupuesto (solo ADMIN)
router.delete(
  '/:id',
  authorize('ADMIN'),
  presupuestoController.deletePresupuesto
);

export default router;
```

### 6. Integrar Rutas en el Index Principal

**Actualizar:** `backend/src/index.ts`

```typescript
// ... imports existentes
import presupuestoRoutes from './routes/presupuesto.routes';

// ... configuraci√≥n existente

// Rutas
app.use('/api/auth', authRoutes);
app.use('/api/clientes', clienteRoutes);
app.use('/api/presupuestos', presupuestoRoutes); // ‚Üê Agregar esta l√≠nea

// ... resto del c√≥digo
```

## Criterios de √âxito

‚úÖ **CRUD de Presupuestos completo:**
  - GET /api/presupuestos (con filtros) ‚úÖ
  - GET /api/presupuestos/:id ‚úÖ
  - POST /api/presupuestos ‚úÖ
  - PUT /api/presupuestos/:id ‚úÖ
  - DELETE /api/presupuestos/:id ‚úÖ

‚úÖ **Generaci√≥n Autom√°tica de Folios:**
  - Formato PRE-{YYYY}{MM}{###} ‚úÖ
  - Secuencial por mes ‚úÖ
  - Sin duplicados ‚úÖ

‚úÖ **Gesti√≥n de Estados:**
  - PENDIENTE (por defecto) ‚úÖ
  - ACEPTADO (manual) ‚úÖ
  - RECHAZADO (manual) ‚úÖ
  - VENCIDO (autom√°tico) ‚úÖ

‚úÖ **Conversi√≥n a Orden:**
  - POST /api/presupuestos/:id/convertir-orden ‚úÖ
  - Genera folio de orden autom√°ticamente ‚úÖ
  - Vincula presupuesto con orden ‚úÖ
  - Solo permite conversi√≥n si est√° ACEPTADO ‚úÖ

‚úÖ **Env√≠o por WhatsApp:**
  - GET /api/presupuestos/:id/whatsapp ‚úÖ
  - Genera mensaje personalizado ‚úÖ
  - Retorna enlace de WhatsApp ‚úÖ
  - Registra fecha de env√≠o ‚úÖ

‚úÖ **C√°lculo Autom√°tico de Fechas:**
  - Fecha de vencimiento basada en vigenciaDias ‚úÖ
  - Actualizaci√≥n autom√°tica de estado a VENCIDO ‚úÖ

## Comandos de Verificaci√≥n

```bash
# Crear presupuesto
curl -X POST http://localhost:5000/api/presupuestos \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "clienteId": "uuid-del-cliente",
    "descripcionProblema": "Pantalla rota",
    "montoEstimado": 1500,
    "vigenciaDias": 15
  }'

# Listar presupuestos
curl -X GET "http://localhost:5000/api/presupuestos?estado=PENDIENTE" \
  -H "Authorization: Bearer $TOKEN"

# Cambiar estado a ACEPTADO
curl -X PATCH http://localhost:5000/api/presupuestos/{id}/estado \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"estado": "ACEPTADO"}'

# Convertir a orden
curl -X POST http://localhost:5000/api/presupuestos/{id}/convertir-orden \
  -H "Authorization: Bearer $TOKEN"

# Generar enlace de WhatsApp
curl -X GET http://localhost:5000/api/presupuestos/{id}/whatsapp \
  -H "Authorization: Bearer $TOKEN"
```

## Ejemplo de Respuesta

### POST /api/presupuestos

```json
{
  "success": true,
  "message": "Presupuesto creado exitosamente",
  "data": {
    "id": "uuid",
    "folio": "PRE-202601001",
    "clienteId": "uuid-cliente",
    "equipoId": null,
    "descripcionProblema": "Pantalla rota",
    "montoEstimado": 1500.00,
    "estado": "PENDIENTE",
    "vigenciaDias": 15,
    "fechaVencimiento": "2026-01-16T00:00:00.000Z",
    "cliente": {
      "nombre": "Juan",
      "apellido": "P√©rez",
      "telefono": "5551234567"
    }
  }
}
```

## Problemas Comunes y Soluciones

**Error: "No se puede convertir presupuesto sin equipo"**
- Soluci√≥n: Asegurarse de que el presupuesto tenga un equipoId antes de convertir.

**Folios duplicados**
- Soluci√≥n: La generaci√≥n usa `findFirst` con `orderBy desc`. Verificar que el √≠ndice en `folio` est√© creado.

**Estado no se actualiza a VENCIDO**
- Soluci√≥n: La actualizaci√≥n se hace al consultar. Considerar crear un cron job para actualizar masivamente.

**Enlace de WhatsApp no funciona**
- Soluci√≥n: Verificar que el tel√©fono est√© en formato internacional sin s√≠mbolos.

## Entregables

1. ‚úÖ `backend/src/validators/presupuesto.validator.ts` - Validaciones Zod
2. ‚úÖ `backend/src/utils/presupuesto.util.ts` - Utilidades (folio, fechas, WhatsApp)
3. ‚úÖ `backend/src/services/presupuesto.service.ts` - L√≥gica de negocio
4. ‚úÖ `backend/src/controllers/presupuesto.controller.ts` - Controlador
5. ‚úÖ `backend/src/routes/presupuesto.routes.ts` - Rutas
6. ‚úÖ Rutas integradas en `src/index.ts`

## Pr√≥ximos Pasos

Una vez completado este m√≥dulo:
- **05.2-presupuestos-frontend**: Implementar UI para gesti√≥n de presupuestos
- **06.1-ordenes-backend**: Usar presupuestos como base para √≥rdenes

## Referencias

- Prisma: https://www.prisma.io/docs
- Express.js: https://expressjs.com/
- Zod: https://zod.dev/
- WhatsApp API: https://faq.whatsapp.com/general/chats/how-to-use-click-to-chat/
