# Agent: Database - Inventario y Pagos

> **Nota Importante:** Todos los procesos, informes y comunicaciones de este agente deben realizarse en espa√±ol hispanohablante para facilitar la comprensi√≥n y colaboraci√≥n del equipo.

## Rol
Especialista en Base de Datos enfocado en la implementaci√≥n de las tablas de inventario (refacciones y accesorios), movimientos de inventario, ventas y sistema de pagos.

## Objetivo
Implementar las tablas `refacciones_catalogo`, `refacciones_usadas` (relaci√≥n N:N con √≥rdenes), `movimientos_inventario`, `accesorios`, `ventas`, `ventas_items` y `pagos` en el schema de Prisma, crear seeds de datos de prueba con inventario variado, y asegurar el control completo del stock y flujo de pagos.

## Contexto del Proyecto
SalvaCell es un sistema de gesti√≥n integral para talleres de reparaci√≥n de dispositivos m√≥viles. Este agente se enfoca espec√≠ficamente en:
- Control de inventario de refacciones para reparaciones
- Gesti√≥n de accesorios para venta
- Registro de movimientos de inventario (entradas, salidas, ajustes)
- Sistema de pagos vinculado a √≥rdenes
- Ventas directas de accesorios
- Alertas de stock bajo

## Documentaci√≥n de Referencia
Revisar los siguientes documentos en la carpeta `/home/runner/work/SalvaCell/SalvaCell/docs/`:
- `FSD.md` - Secci√≥n 3.1 (modelos de inventario y pagos)
- `SRS.md` - Secci√≥n 3.5 (Inventario) y 3.6 (Pagos)
- `PRD.md` - Secci√≥n 4 (Control de inventario)
- `BRD.md` - Requisitos de negocio relacionados con inventario

## Prerequisitos
‚úÖ Los agentes anteriores deben haber creado: User, Cliente, Equipo, Orden
‚úÖ Debe existir la carpeta `prisma/` con `schema.prisma`
‚úÖ PostgreSQL debe estar configurado

## Tareas Espec√≠ficas

### 1. Implementar Modelo Refaccion (Cat√°logo)
**Archivo:** `prisma/schema.prisma`

```prisma
model Refaccion {
  id                String              @id @default(uuid())
  codigo            String              @unique // SKU o c√≥digo interno
  nombre            String
  descripcion       String?             @db.Text
  categoria         CategoriaRefaccion
  tipo              TipoRefaccion       @default(GENERICA)
  
  // Compatibilidad
  marcasCompatibles String              // JSON o texto separado por comas
  modelosCompatibles String?            @db.Text
  
  // Precios
  precioCompra      Decimal             @db.Decimal(10, 2)
  precioVenta       Decimal             @db.Decimal(10, 2)
  
  // Inventario
  stockActual       Int                 @default(0)
  stockMinimo       Int                 @default(5)
  stockMaximo       Int?
  
  // Proveedor
  proveedor         String?
  
  // Estado
  activo            Boolean             @default(true)
  
  // Timestamps
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  // Relaciones
  ordenesRefacciones OrdenRefaccion[]
  movimientos       MovimientoInventario[]
  
  // √çndices
  @@index([codigo])
  @@index([categoria])
  @@index([stockActual])
  @@index([activo])
  @@map("refacciones")
}

enum CategoriaRefaccion {
  PANTALLA
  BATERIA
  CONECTOR_CARGA
  CAMARA
  BOCINA
  MICROFONO
  FLEX
  BOTONERA
  TAPA_TRASERA
  CRISTAL
  PLACA_BASE
  OTRO
}

enum TipoRefaccion {
  ORIGINAL      // Original del fabricante
  GENERICA      // Compatible gen√©rica
  USADA         // De segunda mano
  REACONDICIONADA // Reparada/restaurada
}
```

**Validaciones importantes:**
- `codigo` debe ser √∫nico (SKU del producto)
- `precioVenta` debe ser >= `precioCompra` (validar en backend)
- `stockActual` no puede ser negativo
- `stockMinimo` para alertas autom√°ticas

### 2. Implementar Modelo OrdenRefaccion (Tabla Intermedia)
**Archivo:** `prisma/schema.prisma`

```prisma
model OrdenRefaccion {
  id            String   @id @default(uuid())
  ordenId       String
  refaccionId   String
  cantidad      Int      @default(1)
  precioUnitario Decimal @db.Decimal(10, 2)
  precioTotal   Decimal  @db.Decimal(10, 2) // cantidad * precioUnitario
  descuento     Decimal  @default(0) @db.Decimal(10, 2)
  
  createdAt     DateTime @default(now())
  
  // Relaciones
  orden         Orden    @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  refaccion     Refaccion @relation(fields: [refaccionId], references: [id], onDelete: Restrict)
  
  // √çndices
  @@index([ordenId])
  @@index([refaccionId])
  @@map("ordenes_refacciones")
}
```

**Validaciones importantes:**
- `cantidad` debe ser > 0
- `precioTotal` = (`cantidad` * `precioUnitario`) - `descuento`
- Al crear registro, descontar del `stockActual` de la refacci√≥n
- `onDelete: Cascade` en orden, `Restrict` en refacci√≥n

### 3. Implementar Modelo MovimientoInventario
**Archivo:** `prisma/schema.prisma`

```prisma
model MovimientoInventario {
  id            String            @id @default(uuid())
  refaccionId   String
  tipo          TipoMovimiento
  cantidad      Int
  stockAnterior Int
  stockNuevo    Int
  
  // Referencia (opcional)
  ordenId       String?
  ventaId       String?
  
  // Informaci√≥n adicional
  motivo        String?           @db.Text
  usuarioId     String
  
  // Timestamps
  createdAt     DateTime          @default(now())
  
  // Relaciones
  refaccion     Refaccion         @relation(fields: [refaccionId], references: [id], onDelete: Cascade)
  usuario       User              @relation("MovimientoUsuario", fields: [usuarioId], references: [id], onDelete: Restrict)
  orden         Orden?            @relation(fields: [ordenId], references: [id], onDelete: SetNull)
  venta         Venta?            @relation(fields: [ventaId], references: [id], onDelete: SetNull)
  
  // √çndices
  @@index([refaccionId])
  @@index([tipo])
  @@index([createdAt])
  @@index([usuarioId])
  @@map("movimientos_inventario")
}

enum TipoMovimiento {
  ENTRADA         // Compra o ingreso al inventario
  SALIDA          // Uso en reparaci√≥n o venta
  AJUSTE_POSITIVO // Correcci√≥n de inventario (m√°s stock)
  AJUSTE_NEGATIVO // Correcci√≥n de inventario (menos stock)
  DEVOLUCION      // Devoluci√≥n de cliente
  MERMA           // P√©rdida o da√±o
}
```

**Validaciones importantes:**
- Registrar TODOS los movimientos de inventario (auditor√≠a completa)
- `stockNuevo` = `stockAnterior` ¬± `cantidad` seg√∫n tipo
- Vincular con `ordenId` cuando sea por reparaci√≥n
- Vincular con `ventaId` cuando sea por venta de accesorio

### 4. Implementar Modelo Accesorio
**Archivo:** `prisma/schema.prisma`

```prisma
model Accesorio {
  id            String   @id @default(uuid())
  codigo        String   @unique // SKU
  nombre        String
  descripcion   String?  @db.Text
  categoria     CategoriaAccesorio
  marca         String?
  
  // Precios
  precioCompra  Decimal  @db.Decimal(10, 2)
  precioVenta   Decimal  @db.Decimal(10, 2)
  
  // Inventario
  stockActual   Int      @default(0)
  stockMinimo   Int      @default(10)
  
  // Estado
  activo        Boolean  @default(true)
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relaciones
  ventasItems   VentaItem[]
  
  // √çndices
  @@index([codigo])
  @@index([categoria])
  @@index([stockActual])
  @@index([activo])
  @@map("accesorios")
}

enum CategoriaAccesorio {
  FUNDA
  MICA
  CARGADOR
  CABLE
  AUDIFONOS
  MEMORIA
  SOPORTE
  LIMPIEZA
  OTRO
}
```

### 5. Implementar Modelo Venta
**Archivo:** `prisma/schema.prisma`

```prisma
model Venta {
  id            String      @id @default(uuid())
  folio         String      @unique // VEN-YYYYMM###
  clienteId     String?     // Opcional, puede ser venta sin cliente registrado
  vendedorId    String
  
  // Informaci√≥n del cliente (si no est√° registrado)
  clienteNombre String?
  
  // Totales
  subtotal      Decimal     @default(0) @db.Decimal(10, 2)
  descuento     Decimal     @default(0) @db.Decimal(10, 2)
  total         Decimal     @default(0) @db.Decimal(10, 2)
  
  // Pago
  metodoPago    MetodoPago  @default(EFECTIVO)
  pagado        Boolean     @default(false)
  
  // Notas
  notas         String?     @db.Text
  
  // Timestamps
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relaciones
  cliente       Cliente?    @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  vendedor      User        @relation("VentaVendedor", fields: [vendedorId], references: [id], onDelete: Restrict)
  items         VentaItem[]
  movimientos   MovimientoInventario[]
  
  // √çndices
  @@index([folio])
  @@index([clienteId])
  @@index([vendedorId])
  @@index([createdAt])
  @@map("ventas")
}
```

### 6. Implementar Modelo VentaItem
**Archivo:** `prisma/schema.prisma`

```prisma
model VentaItem {
  id              String    @id @default(uuid())
  ventaId         String
  accesorioId     String
  cantidad        Int       @default(1)
  precioUnitario  Decimal   @db.Decimal(10, 2)
  subtotal        Decimal   @db.Decimal(10, 2) // cantidad * precioUnitario
  descuento       Decimal   @default(0) @db.Decimal(10, 2)
  total           Decimal   @db.Decimal(10, 2) // subtotal - descuento
  
  createdAt       DateTime  @default(now())
  
  // Relaciones
  venta           Venta     @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  accesorio       Accesorio @relation(fields: [accesorioId], references: [id], onDelete: Restrict)
  
  // √çndices
  @@index([ventaId])
  @@index([accesorioId])
  @@map("ventas_items")
}
```

### 7. Implementar Modelo Pago
**Archivo:** `prisma/schema.prisma`

```prisma
model Pago {
  id            String      @id @default(uuid())
  folio         String      @unique // PAG-YYYYMM###
  ordenId       String
  
  // Informaci√≥n del pago
  monto         Decimal     @db.Decimal(10, 2)
  metodoPago    MetodoPago  @default(EFECTIVO)
  referencia    String?     // N√∫mero de transacci√≥n/cheque
  
  // Tipo de pago
  tipoPago      TipoPago    @default(ANTICIPO)
  
  // Usuario y fecha
  usuarioId     String
  fechaPago     DateTime    @default(now())
  
  // Notas
  notas         String?     @db.Text
  
  // Timestamps
  createdAt     DateTime    @default(now())
  
  // Relaciones
  orden         Orden       @relation(fields: [ordenId], references: [id], onDelete: Restrict)
  usuario       User        @relation("PagoUsuario", fields: [usuarioId], references: [id], onDelete: Restrict)
  
  // √çndices
  @@index([folio])
  @@index([ordenId])
  @@index([fechaPago])
  @@index([metodoPago])
  @@map("pagos")
}

enum MetodoPago {
  EFECTIVO
  TARJETA_DEBITO
  TARJETA_CREDITO
  TRANSFERENCIA
  DEPOSITO
  OTRO
}

enum TipoPago {
  ANTICIPO      // Pago parcial inicial
  LIQUIDACION   // Pago final/completo
  ABONO         // Pago parcial adicional
}
```

**Validaciones importantes:**
- `monto` debe ser > 0
- No permitir pago mayor al adeudo de la orden
- Actualizar `totalPagado` y `adeudo` de la orden al crear pago

### 8. Crear Seeds de Refacciones
**Archivo:** `prisma/seed.ts`

Crear cat√°logo de refacciones com√∫n en talleres:

```typescript
const refacciones = [
  // Pantallas iPhone
  {
    codigo: "PANT-IP13PRO-ORI",
    nombre: "Pantalla iPhone 13 Pro OLED",
    descripcion: "Pantalla OLED original, incluye flex y touch",
    categoria: "PANTALLA",
    tipo: "ORIGINAL",
    marcasCompatibles: "Apple",
    modelosCompatibles: "iPhone 13 Pro",
    precioCompra: 1800.00,
    precioVenta: 2500.00,
    stockActual: 3,
    stockMinimo: 2,
    proveedor: "Proveedor Premium Tech",
    activo: true,
  },
  {
    codigo: "PANT-IP13-GEN",
    nombre: "Pantalla iPhone 13 Gen√©rica",
    descripcion: "Pantalla compatible gen√©rica alta calidad",
    categoria: "PANTALLA",
    tipo: "GENERICA",
    marcasCompatibles: "Apple",
    modelosCompatibles: "iPhone 13",
    precioCompra: 800.00,
    precioVenta: 1200.00,
    stockActual: 5,
    stockMinimo: 3,
    proveedor: "Distribuidora XYZ",
    activo: true,
  },
  {
    codigo: "PANT-IP11-GEN",
    nombre: "Pantalla iPhone 11 LCD",
    descripcion: "Pantalla LCD compatible, buena calidad",
    categoria: "PANTALLA",
    tipo: "GENERICA",
    marcasCompatibles: "Apple",
    modelosCompatibles: "iPhone 11",
    precioCompra: 600.00,
    precioVenta: 900.00,
    stockActual: 8,
    stockMinimo: 4,
    proveedor: "Distribuidora XYZ",
    activo: true,
  },
  
  // Pantallas Samsung
  {
    codigo: "PANT-S21-ORI",
    nombre: "Pantalla Samsung Galaxy S21 AMOLED",
    descripcion: "Pantalla AMOLED original Samsung",
    categoria: "PANTALLA",
    tipo: "ORIGINAL",
    marcasCompatibles: "Samsung",
    modelosCompatibles: "Galaxy S21, S21 5G",
    precioCompra: 1500.00,
    precioVenta: 2200.00,
    stockActual: 2,
    stockMinimo: 2,
    proveedor: "Proveedor Premium Tech",
    activo: true,
  },
  {
    codigo: "PANT-A52-GEN",
    nombre: "Pantalla Samsung Galaxy A52",
    descripcion: "Pantalla compatible gen√©rica",
    categoria: "PANTALLA",
    tipo: "GENERICA",
    marcasCompatibles: "Samsung",
    modelosCompatibles: "Galaxy A52, A52 5G",
    precioCompra: 500.00,
    precioVenta: 800.00,
    stockActual: 6,
    stockMinimo: 3,
    proveedor: "Distribuidora XYZ",
    activo: true,
  },
  
  // Bater√≠as
  {
    codigo: "BAT-IP13PRO-ORI",
    nombre: "Bater√≠a iPhone 13 Pro Original",
    descripcion: "Bater√≠a original Apple 3095mAh",
    categoria: "BATERIA",
    tipo: "ORIGINAL",
    marcasCompatibles: "Apple",
    modelosCompatibles: "iPhone 13 Pro",
    precioCompra: 1000.00,
    precioVenta: 1500.00,
    stockActual: 0, // ALERTA: Stock agotado
    stockMinimo: 3,
    proveedor: "Proveedor Premium Tech",
    activo: true,
  },
  {
    codigo: "BAT-IP11-GEN",
    nombre: "Bater√≠a iPhone 11 Compatible",
    descripcion: "Bater√≠a compatible 3110mAh",
    categoria: "BATERIA",
    tipo: "GENERICA",
    marcasCompatibles: "Apple",
    modelosCompatibles: "iPhone 11",
    precioCompra: 300.00,
    precioVenta: 500.00,
    stockActual: 10,
    stockMinimo: 5,
    proveedor: "Distribuidora XYZ",
    activo: true,
  },
  {
    codigo: "BAT-S21-ORI",
    nombre: "Bater√≠a Samsung Galaxy S21",
    descripcion: "Bater√≠a original Samsung 4000mAh",
    categoria: "BATERIA",
    tipo: "ORIGINAL",
    marcasCompatibles: "Samsung",
    modelosCompatibles: "Galaxy S21",
    precioCompra: 600.00,
    precioVenta: 900.00,
    stockActual: 4,
    stockMinimo: 3,
    proveedor: "Proveedor Premium Tech",
    activo: true,
  },
  
  // Conectores de carga
  {
    codigo: "CONN-IPLIGHT-GEN",
    nombre: "Conector Lightning iPhone",
    descripcion: "Flex de conector de carga Lightning",
    categoria: "CONECTOR_CARGA",
    tipo: "GENERICA",
    marcasCompatibles: "Apple",
    modelosCompatibles: "iPhone 11, 12, 13, XR, XS",
    precioCompra: 80.00,
    precioVenta: 150.00,
    stockActual: 15,
    stockMinimo: 8,
    proveedor: "Distribuidora XYZ",
    activo: true,
  },
  {
    codigo: "CONN-USBC-GEN",
    nombre: "Conector USB-C Universal",
    descripcion: "Conector USB-C para Samsung/Xiaomi/Motorola",
    categoria: "CONECTOR_CARGA",
    tipo: "GENERICA",
    marcasCompatibles: "Samsung, Xiaomi, Motorola",
    modelosCompatibles: "Modelos con USB-C",
    precioCompra: 60.00,
    precioVenta: 120.00,
    stockActual: 20,
    stockMinimo: 10,
    proveedor: "Distribuidora XYZ",
    activo: true,
  },
  
  // C√°maras
  {
    codigo: "CAM-IP13PRO-TRAS-ORI",
    nombre: "C√°mara Trasera iPhone 13 Pro",
    descripcion: "M√≥dulo c√°mara triple original",
    categoria: "CAMARA",
    tipo: "ORIGINAL",
    marcasCompatibles: "Apple",
    modelosCompatibles: "iPhone 13 Pro",
    precioCompra: 2000.00,
    precioVenta: 2800.00,
    stockActual: 1,
    stockMinimo: 1,
    proveedor: "Proveedor Premium Tech",
    activo: true,
  },
  {
    codigo: "CAM-FRONT-UNIV",
    nombre: "C√°mara Frontal Universal 8MP",
    descripcion: "C√°mara frontal compatible para gama media",
    categoria: "CAMARA",
    tipo: "GENERICA",
    marcasCompatibles: "Samsung, Xiaomi, Motorola",
    modelosCompatibles: "Varios modelos gama media",
    precioCompra: 150.00,
    precioVenta: 250.00,
    stockActual: 12,
    stockMinimo: 5,
    proveedor: "Distribuidora XYZ",
    activo: true,
  },
  
  // Bocinas y micr√≥fonos
  {
    codigo: "BOC-IP-UNIV",
    nombre: "Bocina iPhone Universal",
    descripcion: "Bocina interna compatible iPhone",
    categoria: "BOCINA",
    tipo: "GENERICA",
    marcasCompatibles: "Apple",
    modelosCompatibles: "iPhone 11, 12, 13, XR",
    precioCompra: 50.00,
    precioVenta: 100.00,
    stockActual: 10,
    stockMinimo: 6,
    proveedor: "Distribuidora XYZ",
    activo: true,
  },
  {
    codigo: "MIC-UNIV",
    nombre: "Micr√≥fono Universal",
    descripcion: "Micr√≥fono interno gen√©rico",
    categoria: "MICROFONO",
    tipo: "GENERICA",
    marcasCompatibles: "Universal",
    modelosCompatibles: "Mayor√≠a de modelos",
    precioCompra: 30.00,
    precioVenta: 60.00,
    stockActual: 18,
    stockMinimo: 10,
    proveedor: "Distribuidora XYZ",
    activo: true,
  },
  
  // Cristales y tapas
  {
    codigo: "CRIS-IP13-GEN",
    nombre: "Cristal Trasero iPhone 13",
    descripcion: "Tapa trasera de vidrio",
    categoria: "CRISTAL",
    tipo: "GENERICA",
    marcasCompatibles: "Apple",
    modelosCompatibles: "iPhone 13",
    precioCompra: 200.00,
    precioVenta: 350.00,
    stockActual: 5,
    stockMinimo: 3,
    proveedor: "Distribuidora XYZ",
    activo: true,
  },
];
```

**Total de refacciones:** 25-30 con stock variado y algunas con stock bajo

### 9. Crear Seeds de Accesorios
**Archivo:** `prisma/seed.ts`

```typescript
const accesorios = [
  // Fundas
  {
    codigo: "FUN-IP13-SIL-NEG",
    nombre: "Funda Silic√≥n iPhone 13 Negro",
    descripcion: "Funda de silic√≥n suave, protecci√≥n total",
    categoria: "FUNDA",
    marca: "Gen√©rica",
    precioCompra: 30.00,
    precioVenta: 80.00,
    stockActual: 25,
    stockMinimo: 10,
    activo: true,
  },
  {
    codigo: "FUN-IP13-SIL-AZU",
    nombre: "Funda Silic√≥n iPhone 13 Azul",
    categoria: "FUNDA",
    marca: "Gen√©rica",
    precioCompra: 30.00,
    precioVenta: 80.00,
    stockActual: 20,
    stockMinimo: 10,
    activo: true,
  },
  {
    codigo: "FUN-SAM-UNIV",
    nombre: "Funda Universal Samsung",
    descripcion: "Funda TPU transparente",
    categoria: "FUNDA",
    marca: "Gen√©rica",
    precioCompra: 25.00,
    precioVenta: 60.00,
    stockActual: 30,
    stockMinimo: 15,
    activo: true,
  },
  
  // Micas
  {
    codigo: "MIC-VID-IP13",
    nombre: "Mica Vidrio Templado iPhone 13",
    descripcion: "Protector de pantalla 9H",
    categoria: "MICA",
    marca: "Premium",
    precioCompra: 15.00,
    precioVenta: 50.00,
    stockActual: 40,
    stockMinimo: 20,
    activo: true,
  },
  {
    codigo: "MIC-VID-SAM-UNIV",
    nombre: "Mica Vidrio Samsung Universal",
    descripcion: "Protector gen√©rico para Samsung",
    categoria: "MICA",
    marca: "Gen√©rica",
    precioCompra: 12.00,
    precioVenta: 40.00,
    stockActual: 35,
    stockMinimo: 20,
    activo: true,
  },
  
  // Cargadores
  {
    codigo: "CARG-IPHONE-20W",
    nombre: "Cargador iPhone 20W USB-C",
    descripcion: "Cargador r√°pido compatible iPhone",
    categoria: "CARGADOR",
    marca: "Compatible Apple",
    precioCompra: 80.00,
    precioVenta: 150.00,
    stockActual: 12,
    stockMinimo: 8,
    activo: true,
  },
  {
    codigo: "CARG-UNIV-2A",
    nombre: "Cargador Universal 2A",
    descripcion: "Cargador USB 2 amperios",
    categoria: "CARGADOR",
    marca: "Gen√©rica",
    precioCompra: 30.00,
    precioVenta: 70.00,
    stockActual: 20,
    stockMinimo: 10,
    activo: true,
  },
  
  // Cables
  {
    codigo: "CAB-LIGHT-1M",
    nombre: "Cable Lightning 1m",
    descripcion: "Cable de datos y carga Lightning",
    categoria: "CABLE",
    marca: "Compatible Apple",
    precioCompra: 25.00,
    precioVenta: 60.00,
    stockActual: 30,
    stockMinimo: 15,
    activo: true,
  },
  {
    codigo: "CAB-USBC-1M",
    nombre: "Cable USB-C 1m",
    descripcion: "Cable USB-C a USB-C",
    categoria: "CABLE",
    marca: "Gen√©rica",
    precioCompra: 20.00,
    precioVenta: 50.00,
    stockActual: 25,
    stockMinimo: 15,
    activo: true,
  },
  
  // Aud√≠fonos
  {
    codigo: "AUD-BT-TWS",
    nombre: "Aud√≠fonos Bluetooth TWS",
    descripcion: "Aud√≠fonos inal√°mbricos tipo AirPods",
    categoria: "AUDIFONOS",
    marca: "Gen√©rica",
    precioCompra: 100.00,
    precioVenta: 200.00,
    stockActual: 8,
    stockMinimo: 5,
    activo: true,
  },
  {
    codigo: "AUD-CABLE-35MM",
    nombre: "Aud√≠fonos con Cable 3.5mm",
    descripcion: "Aud√≠fonos alambricos b√°sicos",
    categoria: "AUDIFONOS",
    marca: "Gen√©rica",
    precioCompra: 15.00,
    precioVenta: 40.00,
    stockActual: 15,
    stockMinimo: 10,
    activo: true,
  },
  
  // Memorias
  {
    codigo: "MEM-SD-32GB",
    nombre: "Memoria SD 32GB",
    descripcion: "Memoria microSD clase 10",
    categoria: "MEMORIA",
    marca: "SanDisk",
    precioCompra: 80.00,
    precioVenta: 150.00,
    stockActual: 10,
    stockMinimo: 5,
    activo: true,
  },
  
  // Soportes
  {
    codigo: "SOP-AUTO-MAG",
    nombre: "Soporte Magn√©tico para Auto",
    descripcion: "Soporte con im√°n para celular",
    categoria: "SOPORTE",
    marca: "Gen√©rica",
    precioCompra: 40.00,
    precioVenta: 100.00,
    stockActual: 12,
    stockMinimo: 6,
    activo: true,
  },
  
  // Limpieza
  {
    codigo: "LIM-KIT-BASIC",
    nombre: "Kit de Limpieza para Celular",
    descripcion: "Incluye pa√±o, gel y cepillo",
    categoria: "LIMPIEZA",
    marca: "Gen√©rica",
    precioCompra: 20.00,
    precioVenta: 50.00,
    stockActual: 8,
    stockMinimo: 5,
    activo: true,
  },
];
```

**Total de accesorios:** 15-20 productos variados

### 10. Crear Seeds de Movimientos de Inventario
**Archivo:** `prisma/seed.ts`

Registrar movimientos iniciales de inventario:

```typescript
// Ejemplo de movimientos al agregar el stock inicial
const movimientos = [
  {
    refaccionId: refaccion1.id, // Pantalla iPhone 13 Pro
    tipo: "ENTRADA",
    cantidad: 3,
    stockAnterior: 0,
    stockNuevo: 3,
    motivo: "Stock inicial - compra a proveedor",
    usuarioId: adminUser.id,
    createdAt: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), // Hace 30 d√≠as
  },
  {
    refaccionId: refaccion2.id, // Pantalla iPhone 13 Gen√©rica
    tipo: "ENTRADA",
    cantidad: 8,
    stockAnterior: 0,
    stockNuevo: 8,
    motivo: "Stock inicial",
    usuarioId: adminUser.id,
    createdAt: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000),
  },
  // Salida por orden de reparaci√≥n
  {
    refaccionId: refaccion2.id,
    tipo: "SALIDA",
    cantidad: 1,
    stockAnterior: 8,
    stockNuevo: 7,
    motivo: "Uso en orden ORD-202601001",
    ordenId: orden1.id,
    usuarioId: tecnicoUser.id,
    createdAt: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000),
  },
  // Ajuste de inventario
  {
    refaccionId: refaccion3.id, // Bater√≠a
    tipo: "AJUSTE_NEGATIVO",
    cantidad: 2,
    stockAnterior: 12,
    stockNuevo: 10,
    motivo: "Correcci√≥n de inventario - 2 bater√≠as defectuosas",
    usuarioId: adminUser.id,
    createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000),
  },
];
```

### 11. Crear Seeds de Ventas de Accesorios
**Archivo:** `prisma/seed.ts`

```typescript
const ventas = [
  // Venta a cliente registrado
  {
    folio: "VEN-202601001",
    clienteId: clienteVIP.id,
    vendedorId: recepcionistaUser.id,
    metodoPago: "EFECTIVO",
    subtotal: 130.00,
    descuento: 10.00, // 10 pesos de descuento
    total: 120.00,
    pagado: true,
    createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000),
  },
  // Venta sin cliente registrado
  {
    folio: "VEN-202601002",
    clienteNombre: "Juan P√©rez",
    vendedorId: recepcionistaUser.id,
    metodoPago: "TARJETA_DEBITO",
    subtotal: 80.00,
    descuento: 0,
    total: 80.00,
    pagado: true,
    notas: "Compra r√°pida de funda",
    createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000),
  },
];

const ventasItems = [
  // Items de VEN-202601001
  {
    ventaId: venta1.id,
    accesorioId: micaVidrio.id,
    cantidad: 2,
    precioUnitario: 50.00,
    subtotal: 100.00,
    descuento: 10.00,
    total: 90.00,
  },
  {
    ventaId: venta1.id,
    accesorioId: fundaSilicon.id,
    cantidad: 1,
    precioUnitario: 80.00,
    subtotal: 80.00,
    descuento: 0,
    total: 80.00,
  },
  // Items de VEN-202601002
  {
    ventaId: venta2.id,
    accesorioId: fundaSilicon.id,
    cantidad: 1,
    precioUnitario: 80.00,
    subtotal: 80.00,
    descuento: 0,
    total: 80.00,
  },
];
```

### 12. Crear Seeds de Pagos
**Archivo:** `prisma/seed.ts`

```typescript
const pagos = [
  // Anticipo
  {
    folio: "PAG-202601001",
    ordenId: orden1.id, // Orden con adeudo
    monto: 1000.00,
    metodoPago: "EFECTIVO",
    tipoPago: "ANTICIPO",
    usuarioId: recepcionistaUser.id,
    fechaPago: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000),
    notas: "Anticipo del 40% del total",
  },
  // Liquidaci√≥n completa
  {
    folio: "PAG-202601002",
    ordenId: orden2.id, // Orden pagada completa
    monto: 600.00,
    metodoPago: "TARJETA_DEBITO",
    tipoPago: "LIQUIDACION",
    usuarioId: recepcionistaUser.id,
    fechaPago: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
    referencia: "****1234",
    notas: "Pago completo con tarjeta",
  },
  // Abono
  {
    folio: "PAG-202601003",
    ordenId: orden3.id,
    monto: 500.00,
    metodoPago: "TRANSFERENCIA",
    tipoPago: "ABONO",
    usuarioId: recepcionistaUser.id,
    fechaPago: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000),
    referencia: "TRANS-987654",
    notas: "Abono parcial por transferencia",
  },
];
```

## Criterios de √âxito

‚úÖ El modelo `Refaccion` est√° completo con categor√≠as y tipos
‚úÖ El modelo `OrdenRefaccion` maneja la relaci√≥n N:N entre √≥rdenes y refacciones
‚úÖ El modelo `MovimientoInventario` registra todos los cambios de stock
‚úÖ El modelo `Accesorio` est√° completo con categor√≠as
‚úÖ Los modelos `Venta` y `VentaItem` manejan ventas de accesorios
‚úÖ El modelo `Pago` est√° vinculado correctamente con √≥rdenes

‚úÖ El seed crea al menos:
  - 25-30 refacciones con stock variado
  - 15-20 accesorios
  - 20-30 movimientos de inventario
  - 5-8 ventas de accesorios con items
  - 8-12 pagos vinculados a √≥rdenes

‚úÖ Existen refacciones con stock bajo (< stockMinimo) para probar alertas
‚úÖ Existen refacciones con stock 0 para probar situaciones de agotado
‚úÖ Los precios de venta son mayores a los precios de compra
‚úÖ Los movimientos de inventario mantienen consistencia (stockNuevo correcto)

## Comandos de Verificaci√≥n

```bash
# Verificar refacciones con stock bajo
npx prisma db execute --stdin <<EOF
SELECT codigo, nombre, "stockActual", "stockMinimo"
FROM refacciones
WHERE "stockActual" <= "stockMinimo"
ORDER BY "stockActual" ASC;
EOF

# Ver movimientos de inventario de una refacci√≥n
npx prisma db execute --stdin <<EOF
SELECT m.tipo, m.cantidad, m."stockAnterior", m."stockNuevo", m.motivo, m."createdAt"
FROM movimientos_inventario m
WHERE m."refaccionId" = 'ID_REFACCION'
ORDER BY m."createdAt" DESC;
EOF

# Ventas del d√≠a
npx prisma db execute --stdin <<EOF
SELECT v.folio, v.total, v."metodoPago", c.nombre as cliente
FROM ventas v
LEFT JOIN clientes c ON v."clienteId" = c.id
WHERE DATE(v."createdAt") = CURRENT_DATE
ORDER BY v."createdAt" DESC;
EOF

# Pagos de una orden
npx prisma db execute --stdin <<EOF
SELECT p.folio, p.monto, p."metodoPago", p."tipoPago", p."fechaPago"
FROM pagos p
WHERE p."ordenId" = 'ID_ORDEN'
ORDER BY p."fechaPago" ASC;
EOF

# √ìrdenes con adeudo pendiente
npx prisma db execute --stdin <<EOF
SELECT o.folio, c.nombre, o."costoTotal", o."totalPagado", o.adeudo
FROM ordenes o
JOIN clientes c ON o."clienteId" = c.id
WHERE o.adeudo > 0
ORDER BY o.adeudo DESC;
EOF
```

## Notas Importantes

1. **Control de Stock:**
   - SIEMPRE registrar movimiento antes de modificar stockActual
   - Validar que hay stock disponible antes de crear OrdenRefaccion
   - No permitir stock negativo

2. **Alertas de Stock Bajo:**
   - Generar alerta cuando stockActual <= stockMinimo
   - Mostrar en dashboard las refacciones con stock cr√≠tico

3. **Actualizaci√≥n de Pagos:**
   - Al crear un Pago, actualizar totalPagado y adeudo de la Orden
   - Usar transacciones para garantizar consistencia

4. **C√°lculo de Totales:**
   - En OrdenRefaccion: precioTotal = (cantidad * precioUnitario) - descuento
   - En VentaItem: total = subtotal - descuento
   - En Venta: total = sum(items.total)

5. **Generaci√≥n de Folios:**
   - PAG-YYYYMM### para pagos
   - VEN-YYYYMM### para ventas
   - Secuencial por mes

6. **Descuento de Stock Autom√°tico:**
   - Al crear OrdenRefaccion, descontar de Refaccion.stockActual
   - Al crear VentaItem, descontar de Accesorio.stockActual
   - Registrar en MovimientoInventario

## Problemas Comunes y Soluciones

**Error: "Stock insuficiente"**
- Soluci√≥n: Validar stockActual >= cantidad antes de crear relaci√≥n
- Mostrar mensaje claro al usuario

**Stock negativo en la base**
- Soluci√≥n: Agregar constraint `CHECK (stockActual >= 0)` en PostgreSQL
- Validar en backend tambi√©n

**Totales no coinciden**
- Soluci√≥n: Recalcular totales al crear/actualizar items
- Usar triggers o calcular en backend

**Pagos duplicados**
- Soluci√≥n: Verificar que folio sea √∫nico
- Usar transacci√≥n para crear pago + actualizar orden

## Entregables

1. ‚úÖ Modelos de inventario: `Refaccion`, `OrdenRefaccion`, `MovimientoInventario`, `Accesorio`
2. ‚úÖ Modelos de ventas: `Venta`, `VentaItem`
3. ‚úÖ Modelo de pagos: `Pago`
4. ‚úÖ Enums: `CategoriaRefaccion`, `TipoRefaccion`, `CategoriaAccesorio`, `TipoMovimiento`, `MetodoPago`, `TipoPago`
5. ‚úÖ Seeds con cat√°logo completo de refacciones (25-30)
6. ‚úÖ Seeds con cat√°logo de accesorios (15-20)
7. ‚úÖ Seeds con movimientos de inventario (20-30)
8. ‚úÖ Seeds con ventas y pagos de ejemplo
9. ‚úÖ Migraci√≥n aplicada exitosamente

## Finalizaci√≥n

¬°Con este agente se completa el EQUIPO DATABASE! üéâ

Los 4 agentes del equipo database han implementado:
1. ‚úÖ **01-database-architect.md** - Schema base y configuraci√≥n
2. ‚úÖ **01.2-db-clientes-equipos.md** - Clientes y equipos
3. ‚úÖ **01.3-db-ordenes-presupuestos.md** - √ìrdenes, presupuestos e historial
4. ‚úÖ **01.4-db-inventario-pagos.md** - Inventario, ventas y pagos

El siguiente equipo a implementar es:
üëâ **EQUIPO BACKEND** - Ya hay varios agentes completados (02.1, 03, 04.1, 05.1, 06.1)

## Referencias
- Documentaci√≥n Prisma Decimal: https://www.prisma.io/docs/concepts/components/prisma-schema/data-model#decimal
- Documentaci√≥n Prisma Many-to-Many: https://www.prisma.io/docs/concepts/components/prisma-schema/relations/many-to-many-relations
- Schema de referencia: `/docs/FSD.md` secci√≥n 3.1
- Requerimientos de inventario: `/docs/SRS.md` secci√≥n 3.5 y 3.6
